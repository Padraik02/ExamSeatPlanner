<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå ´åº§ä½éš¨æ©Ÿåˆ†é…ç³»çµ±</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- CSV Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Excel Parser (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { 
            --primary: #007bff;
            --primary-light: #e7f1ff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --success-light: #d4edda;
            --danger: #dc3545;
            --danger-light: #f8d7da;
            --warning: #ffc107;
            --warning-light: #fff3cd;
            --download: #28a745;
            --info: #17a2b8;
            --bg: #ffffff;
            --card-bg: #ffffff;
            --footer-bg: #f1f3f5;
            --border-color: #e5e8f0;
            --text-main: #2c3e50;
            --text-sub: #6c757d;
            
            --seat-w: 62px;
            --seat-h: 40px;
            --aisle-w: 20px;
            --row-label-w: 30px;
        }

        /* åŸºç¤è¨­å®š */
        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å¤–å±¤åŒ…è£ï¼Œç”¨æ–¼æ›è¼‰ Vue ä¸¦è™•ç† Footer ä½ç½® */
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ä¸»å…§å®¹å¡ç‰‡ */
        .main-card { 
            max-width: 1800px; /* è¨­å®šæœ€å¤§å¯¬åº¦ */
            width: 92%;        /* è¨­å®šç›¸å°å¯¬åº¦ */
            margin: 0 auto;    /* ç½®ä¸­ */
            
            background: transparent;
            padding: 40px 0;
            border-radius: 0;
            box-shadow: none;
            flex: 1;
        }

        h1 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: 1px;
            color: #212529;
        }

        /* Stepper é€²åº¦æ¢ */
        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        .stepper::before {
            content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: #e9ecef; z-index: 0; transform: translateY(-50%);
        }
        .step {
            position: relative; z-index: 1; background: var(--card-bg); padding: 0 15px;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .step-circle {
            width: 32px; height: 32px; border-radius: 50%; background: #e9ecef; color: #999;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;
            border: 2px solid #e9ecef; transition: all 0.3s;
        }
        .step-label { font-size: 13px; color: #999; font-weight: 500; }
        
        .step.active .step-circle { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        .step.active .step-label { color: var(--primary); font-weight: 700; }
        .step.completed .step-circle { background: var(--success); color: white; border-color: var(--success); }
        .step.completed .step-label { color: var(--success); }

        /* ä½ˆå±€ç³»çµ± RWD */
        .split-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
            align-items: start;
        }

        /* éå ´å‹•ç•« */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* å¡ç‰‡å…ƒä»¶ */
        .card {
            background: #fff; 
            /* å»ºè­°ï¼šé‚Šæ¡†æ”¹æ·¡ä¸€é»ï¼Œæˆ–æ˜¯åªä¿ç•™ä¸‹é‚Šæ¡†ï¼Œè®“è¦–è¦ºæ›´è¼•é‡ã€‚é€™è£¡å…ˆç¶­æŒæ·¡é‚Šæ¡† */
            border: 1px solid #e9ecef; 
            border-radius: 12px; 
            padding: 25px;
            box-shadow: none; /* ç¢ºä¿å…§å±¤ä¹Ÿæ²’æœ‰é™°å½±ï¼Œå¾¹åº•æ‰å¹³åŒ– */
            margin-bottom: 30px; /* å¢åŠ é–“è·ï¼Œåˆ©ç”¨ç•™ç™½ä¾†å€éš”å…§å®¹ */
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
            padding-bottom: 12px; border-bottom: 1px solid #f1f3f5;
        }.card-header-without-border {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .card-title { font-size: 18px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-title::before {
            /* content: "ğŸ“Œ"; */
            content: "â—†";
            font-size: 18px;
            color: #000;
        }

        /* è¡¨å–®å…ƒä»¶ */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
        .form-control {
            width: 100%; padding: 10px 12px; font-size: 14px; border: 1px solid #ced4da; border-radius: 8px;
            transition: border-color 0.2s;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        textarea.form-control { resize: vertical; min-height: 80px; }

        /* é¸é …èªªæ˜æ–‡å­— */
        .option-desc { font-size: 12px; color: var(--text-sub); margin-top: 6px; line-height: 1.4; padding: 0 4px; }

        /* æŒ‰éˆ•å…ƒä»¶ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            padding: 8px 16px; border-radius: 6px; border: 1px solid transparent;
            font-size: 14px; font-weight: 600; cursor: pointer; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s, filter 0.2s;
            background: #f1f3f5; color: var(--text-main);
        }
        /* æ›´æ–°æŒ‰éˆ•æ‡¸æµ®æ•ˆæœï¼šæ”¾å¤§ 1.1 å€ä¸¦åŠ æ·±é¡è‰² */
        .btn:hover { 
            transform: scale(1.1); 
            filter: brightness(0.9) contrast(1.1); 
            z-index: 5;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }

        .quiet-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            padding: 8px 16px; border-radius: 6px; border: 1px solid transparent;
            font-size: 14px; font-weight: 600; cursor: pointer; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s, filter 0.2s;
            background: #f1f3f5; color: var(--text-main);
        }
        /* æ›´æ–°æŒ‰éˆ•æ‡¸æµ®æ•ˆæœï¼šåŠ æ·±é¡è‰² */
        .quiet-btn:hover { 
            filter: brightness(0.9) contrast(1.1); 
            z-index: 5;
        }

        .action-bar .btn {
            border-radius: 50px; /* é—œéµï¼šè¨­å®šå¤§åœ“è§’ */
            padding-left: 30px;  /* å¢åŠ å·¦å³å¯¬åº¦ï¼Œè®“è† å›Šçœ‹èµ·ä¾†æ›´ä¿®é•·å¥½çœ‹ */
            padding-right: 30px;
        }
        
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-outline { background: white; border-color: #dee2e6; color: var(--text-main); }

        /* ç¶ è‰² Outline æŒ‰éˆ• */
        .btn-outline-download { background: white; border-color: var(--download); color: var(--download); }
        .btn-outline-download:hover { background: var(--download); color: white; }
        
        /* ç´…è‰² Outline æŒ‰éˆ• */
        .btn-outline-danger { background: white; border-color: var(--danger); color: var(--danger);}
        .btn-outline-danger:hover { background: var(--danger); color: white; }

        .btn-sm { padding: 4px 10px; font-size: 12px; }
        
        /* æ¸…ç©ºåå–®æŒ‰éˆ• */
        .btn-clear-list {
            background: transparent; border: 1px solid #dee2e6; color: #666;
            padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;
        }
        .btn-clear-list:hover {
            background: #fff5f5; color: var(--danger); border-color: var(--danger-light);
            transform: scale(1.05); 
        }

        /* --- æ–°å¢ï¼šè¡¨æ ¼å…§ç·¨è¼¯æ¡†æ¨£å¼ --- */
        .table-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid transparent; /* å¹³å¸¸ç„¡é‚Šæ¡† */
            background: transparent;
            border-radius: 4px;
            font-size: 13px;
            color: inherit;
            transition: all 0.2s;
        }
        .table-input:focus {
            background: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        .duplicate .table-input {
            background: #fff3cd; /* é‡è¤‡æ™‚ç¶­æŒé»ƒåº• */
        }

        /* èª¿æ•´ä¸€ä¸‹æ¨™é ­å€å¡Šï¼Œè®“æŒ‰éˆ•æ’ç‰ˆæ›´å¥½çœ‹ */
        .list-header-toolbar {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            flex-wrap: wrap; 
            gap: 10px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .list-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* æ–¹å½¢åˆªé™¤æŒ‰éˆ• */
        .btn-square-danger {
            background: #fff5f5; border: 1px solid #ffc9c9; color: var(--danger);
            width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; transition: 0.2s; padding: 0;
        }
        .btn-square-danger:hover { background: var(--danger); color: white; border-color: var(--danger); transform: scale(1.1); }

        /* æ’åºæŒ‰éˆ• */
        /* è®“è¡¨æ ¼å…§çš„æŒ‰éˆ•æ’ç‰ˆ */
        .btn-sort {
            background: transparent; border: 1px solid #dee2e6; color: #adb5bd;
            cursor: pointer; padding: 2px 6px; font-size: 12px; border-radius: 4px;
        }
        .btn-sort:hover { color: var(--primary); background: #f1f3f5; border-color: var(--primary); }

        /* è† å›ŠæŒ‰éˆ•ç¾¤çµ„ */
        .pill-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .pill-btn {
            padding: 8px 16px; border-radius: 50px; border: 1px solid #dee2e6; background: white;
            font-size: 13px; color: var(--text-sub); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .pill-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; box-shadow: 0 4px 6px rgba(0,123,255,0.2); }
        .pill-btn:hover:not(.active) { background: #f8f9fa; border-color: #adb5bd; transform: scale(1.05); }
        
        /* ç´…è‰²è† å›ŠæŒ‰éˆ• (ç”¨æ–¼æ¸…ç©ºèˆ‡ç§»é™¤é‡è¤‡) */
        .pill-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        .pill-btn.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            box-shadow: 0 4px 6px rgba(220, 53, 69, 0.2);
        }

        /* --- [æ–°å¢] Segmented Control (åˆ†æ®µæ§åˆ¶å™¨) æ¨£å¼ --- */
        .btn-pill-group {
            display: inline-flex;
            border-radius: 999px; /* è† å›Šå½¢ç‹€ */
            border: 1px solid #d1d5db;
            overflow: hidden;
            background: #f9fafb;
            vertical-align: middle;
        }

        .btn-pill {
            border: none;
            border-right: 1px solid #e5e7eb;
            padding: 8px 16px; /* ç¨å¾®å¢åŠ é«˜åº¦è®“é»æ“Šæ›´èˆ’é© */
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-pill:last-child {
            border-right: none;
        }
        
        /* æ»‘é¼ æ‡¸åœæ•ˆæœ (é Active ç‹€æ…‹) */
        .btn-pill:hover:not(.active):not(:disabled) {
            background: #f3f4f6;
            color: #374151;
        }

        /* é¸ä¸­ç‹€æ…‹ */
        .btn-pill.active {
            background: white;
            color: var(--primary); /* ä½¿ç”¨ä¸»é¡Œè—è‰²ï¼Œæˆ–ç”¨ #111827 (æ·±é»‘) */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* å¾®å¼±é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
        }

        /* ç¦ç”¨ç‹€æ…‹ */
        .btn-pill:disabled {
            color: #d1d5db;
            cursor: not-allowed;
            background: #f9fafb;
        }

        /* ç¨ç«‹çš„ç´…è‰²æ“ä½œæŒ‰éˆ• (é…åˆæ–°çš„é«˜åº¦èª¿æ•´) */
        .btn-action-danger {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 8px 16px; 
            border-radius: 999px; 
            border: 1px solid #dc3545;
            color: #dc3545; 
            background: white; 
            font-size: 13px; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-action-danger:hover {
            background: #dc3545; 
            color: white;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
        }

        /* è¡¨æ ¼å…§çš„ç·¨è¼¯æ¡†ï¼šå¹³å¸¸çœ‹èµ·ä¾†åƒæ–‡å­—ï¼Œé»æ“Šè®Šè¼¸å…¥æ¡† */
        .table-input {
            width: 100%;
            border: 1px solid transparent; /* å¹³å¸¸éš±è—é‚Šæ¡† */
            background: transparent;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 13px;
            color: inherit;
            transition: all 0.2s;
        }
        .table-input:hover {
            border-color: #dee2e6; /* æ»‘é¼ ç§»éå»é¡¯ç¤ºæ·¡æ·¡é‚Šæ¡† */
            background: #f8f9fa;
        }
        .table-input:focus {
            border-color: #80bdff;
            background: white;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
        }

        /* Badge å¾½ç«  */
        .badge {
            display: inline-block; padding: 3px 8px; font-size: 11px; font-weight: 700;
            border-radius: 4px; background: #e9ecef; color: var(--text-sub);
        }
        .badge-primary { background: var(--primary-light); color: var(--primary); }
        .badge-success { background: var(--success-light); color: var(--success); }
        .badge-danger { background: var(--danger-light); color: var(--danger); }
        .badge-warning { background: var(--warning-light); color: #856404; }

        /* æ‹–æ›³ä¸Šå‚³å€ */
        .upload-zone {
            border: 2px dashed #dee2e6; border-radius: 12px; padding: 30px 20px;
            text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc;
        }
        .upload-zone:hover, .upload-zone.drag-active { border-color: var(--primary); background: var(--primary-light); }
        .upload-icon { font-size: 32px; margin-bottom: 10px; display: block; }
        
        /* æ•™å®¤ç·¨è¼¯å™¨ - PowerPoint é¢¨æ ¼ */
        .room-slides-container {
            display: flex; gap: 12px; overflow-x: auto; padding: 4px 4px 16px 4px;
            margin-bottom: 20px; scroll-behavior: smooth;
        }
        .room-slide {
            flex: 0 0 160px; height: 110px; background: white; border: 2px solid #e9ecef;
            border-radius: 10px; padding: 10px; cursor: pointer; position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: all 0.2s;
        }
        .room-slide:hover { border-color: #adb5bd; transform: translateY(-2px); }
        .room-slide.active { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .room-slide-add {
            flex: 0 0 140px; /* è·Ÿä¸€èˆ¬è€ƒå ´å¡ç‰‡å·®ä¸å¤šå¯¬ */
            display: flex; 
            flex-direction: column; /* [æ–°å¢] å‚ç›´æ’åˆ— */
            align-items: center; 
            justify-content: center;
            gap: 5px; /* [æ–°å¢] åœ–ç¤ºèˆ‡æ–‡å­—çš„é–“è· */
            
            border: 2px dashed #ced4da; 
            color: #adb5bd; 
            height: 110px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafbfc;
        }
        .room-slide-add:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        /* æ»‘é¼ ç§»éå»çš„æ•ˆæœ (ä¿æŒä¸è®Šï¼Œä½†å»ºè­°ç¢ºèªä¸€ä¸‹) */
        .room-slide-add:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }
        .room-slide-info h4 { font-size: 13px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        .room-slide-stats { font-size: 11px; color: var(--text-sub); }
        /* è€ƒå ´åˆ‡æ›å‹•ç•«ï¼šFade + Scale */
        .room-switch-enter-active,
        .room-switch-leave-active {
            transition: all 0.1s ease-out;
        }
        .room-switch-enter-from {
            opacity: 0;
            transform: translateY(-10px); /* æ–°è€ƒå ´å¾ä¸Šæ–¹ä½ç½®æ»‘å…¥ */
        }
        .room-switch-leave-to {
            opacity: 0;
            transform: translateY(10px); /* èˆŠè€ƒå ´å¾€ä¸‹æ–¹ä½ç½®æ»‘å‡º */
        }

        /* æ•™å®¤å·¥å…·åˆ— */
        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* å·¥å…·åˆ—ï¼šè®Šèº«ç‚ºå¡ç‰‡çš„ã€Œé é¦– (Header)ã€ */
        .toolbar {
            background: #f8f9fa; 
            padding: 12px; /* ç¨å¾®å¢åŠ ä¸€é»å…§è·è®“å®ƒçœ‹èµ·ä¾†åƒæ¨™é¡Œåˆ— */
            
            /* é‚Šæ¡†èˆ‡åœ“è§’è¨­å®šï¼šåªç•™ä¸Šæ–¹åœ“è§’ */
            border: 1px solid #e9ecef;
            border-bottom: 1px solid #dee2e6; /* åŠ æ·±åˆ†éš”ç·šï¼Œå¼·åŒ–å±¤æ¬¡æ„Ÿ */
            border-radius: 12px 12px 0 0; /* ä¸Šåœ“ä¸‹æ–¹ */
            
            /* [é—œéµ] ç§»é™¤åº•éƒ¨é–“è·ï¼Œè®“å®ƒè²¼è‘—ä¸‹é¢çš„ç¶²æ ¼ */
            margin-bottom: 0;
            
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
        }
        .tool-separator { width: 1px; height: 24px; background: #dee2e6; margin: 0 4px; }
        .tool-label { font-size: 12px; font-weight: 600; color: var(--text-sub); margin-right: 4px; }
        .tool-counter {
            font-weight: 800;
            font-size: 14px;
            color: var(--text-main);
            min-width: 30px; /* å›ºå®šæœ€å°å¯¬åº¦é¿å…æ•¸å­—è®Šå‹•æ™‚æŒ‰éˆ•è·³å‹• */
            text-align: center;
            user-select: none;
            display: inline-block;
        }

        /* åº§ä½ç¶²æ ¼ */
        /* ç¶²æ ¼ç·¨è¼¯å™¨ï¼šè®Šèº«ç‚ºå¡ç‰‡çš„ã€Œå…§å®¹ (Body)ã€ */
        .grid-editor-wrapper {
            background: #fff; 
            
            /* é‚Šæ¡†è¨­å®šï¼šç§»é™¤ä¸Šæ–¹é‚Šæ¡† (é¿å…èˆ‡ Toolbar é‡ç–Šè®Šç²—) */
            border: 1px solid #e9ecef; 
            border-top: none; 
            
            /* åœ“è§’è¨­å®šï¼šåªç•™ä¸‹æ–¹åœ“è§’ */
            border-radius: 0 0 12px 12px; /* ä¸Šæ–¹ä¸‹åœ“ */
            
            padding: 30px;
            overflow: auto; 
            min-height: 400px; 
            
            display: block; 
            text-align: center; 
        }
        .grid-layout { 
            display: inline-grid; /* è®Šæˆè¡Œå…§å…ƒç´ ï¼Œæ¥å—çˆ¶å±¤çš„ text-align ç½®ä¸­ */
            padding: 10px 0px 10px 0px;
            gap: 4px; 
            align-items: center; 
            justify-items: center;
            vertical-align: top;  /* ç¢ºä¿å‚ç›´å°é½Š */
        }
        .fading-out {
            animation: animFadeOut 0.3s ease-out forwards;
            pointer-events: none;
        }
        @keyframes animFadeOut {
            0% { opacity: 1; transform: scale(1); background-color: #ffebee; }
            100% { opacity: 0; transform: scale(0.5); background-color: #ffebee; }
        }

        /* [æ–°å¢] æ–°å¢æ™‚çš„éå ´ (è—åº•å½ˆå…¥) */
        .pop-in {
            animation: animPopIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; /* ä½¿ç”¨è²èŒ²æ›²ç·šç‡Ÿé€ å½ˆè·³æ„Ÿ */
        }
        @keyframes animPopIn {
            0% { opacity: 0; transform: scale(0.5); background-color: #e3f2fd; }
            100% { opacity: 1; transform: scale(1); background-color: transparent; }
        }
        .seat {
            width: var(--seat-w); height: var(--seat-h);
            background: white; 
            border: 1px solid #ced4da; 
            border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; user-select: none; 
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .seat:hover { 
            border-color: var(--primary); 
            transform: scale(1.05);
            z-index: 2; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .seat.blocked { 
            background: #f1f3f5; 
            border-color: transparent; 
            color: #adb5bd; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); /* å…§é™°å½±è®“å®ƒçœ‹èµ·ä¾†æ˜¯å‡¹é™·/å¡«æ»¿çš„ */
            
            /* ç•¶åŠ ä¸Š blocked class æ™‚ï¼ŒåŸ·è¡Œå½ˆè·³å¡«æ»¿å‹•ç•« */
            animation: anim-seat-fill 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .seat.blocked:hover { 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); /* åŠ æ·±å…§é™°å½± */
        }
        /* Blocked ç‹€æ…‹ä¸‹çš„ X ç¬¦è™Ÿå‹•ç•« */
        .seat.blocked span {
            font-weight: bold;
            font-size: 14px;
            animation: anim-pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .seat.aisle { visibility: hidden; pointer-events: none; }
        .seat.student { 
            background: #e3f2fd; border-color: #90caf9; color: #1565c0;
        }
        /* --- å‹•ç•« Keyframes --- */
        /* 1. åº§ä½å¡«æ»¿å‹•ç•«ï¼šç¨å¾®ç¸®å°(æŒ‰å£“æ„Ÿ)å†æ”¾å¤§ */
        @keyframes anim-seat-fill {
            0% { transform: scale(1); background-color: white; }
            40% { transform: scale(0.9); background-color: #f1f3f5; } /* æŒ‰ä¸‹å» */
            100% { transform: scale(1); background-color: #f1f3f5; } /* å½ˆå›ä¾† */
        }
        /* 2. ç¬¦è™Ÿå½ˆå‡ºå‹•ç•«ï¼šå¾ç„¡åˆ°æœ‰å½ˆå‡ºä¾† */
        @keyframes anim-pop-in {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }

        .s-id { font-weight: 700; font-size: 11px; line-height: 1.2; }
        .s-name { font-size: 10px; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 95%; }
        
        .row-header, .col-header {
            font-size: 11px; font-weight: 700; color: #adb5bd; text-align: center; padding: 2px;
            cursor: pointer; transition: color 0.2s;
        }
        .row-header:hover, .col-header:hover { color: var(--primary); background: var(--primary-light); border-radius: 4px; }
        .col-header.aisle-label { writing-mode: vertical-rl; letter-spacing: 2px; font-size: 10px; }
        .seat-coord { position: absolute; bottom: 2px; right: 2px; font-size: 9px; color: #dee2e6; pointer-events: none; }

        /* åº•éƒ¨æ“ä½œæ¬„ */
        .action-bar {
            margin-top: 30px; padding-top: 20px; padding-bottom: 50px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* çµ±è¨ˆèˆ‡æç¤º */
        /* å®¹å™¨æ”¹ç‚ºæ©«å‘æ’åˆ—ï¼Œä¸¦å…è¨±æ›è¡Œ */
        .stats-chip-container {
            display: flex; 
            flex-direction: row;  /* é—œéµï¼šæ©«å‘ */
            flex-wrap: wrap;      /* é—œéµï¼šç©ºé–“ä¸è¶³æ™‚è‡ªå‹•æ›è¡Œ */
            gap: 10px;            /* è† å›Šä¹‹é–“çš„é–“è· */
            align-items: center;
        }
        /* è† å›Šæ¨£å¼ï¼šç§»é™¤å›ºå®šå¯¬åº¦ï¼Œæ”¹ç‚ºè‡ªå‹•é©æ‡‰ */
        .stats-chip {
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            padding: 6px 16px;
            background: #f1f3f5;
            border: 1px solid #e5e7eb;
            border-radius: 50px;
            font-size: 13px; 
            color: #495057;
            width: auto;
            justify-content: center;
            transition: all 0.2s;
        }
        .stats-chip {
            padding: 4px 8px;
            border-radius: 999px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }
        /* è®“æ•¸å­—æ›´æ˜é¡¯ä¸€é» */
        .stats-chip strong {
            font-weight: 800;
            color: #212529;
            font-size: 14px;
            margin: 0 2px;
        }
        /* åœ“é»å¾®èª¿ */
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            flex-shrink: 0; /* é˜²æ­¢åœ“é»è¢«å£“ç¸® */
        }
        .dot.green { background: var(--success); }
        .dot.red { background: var(--danger); }
        .dot.blue { background: var(--primary); }
        .dot.black { background: #333; }

        .hint-box {
            background: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px 15px; border-radius: 8px; font-size: 13px; margin-top: 10px;
            display: flex; gap: 8px; align-items: start;
        }

        .status-msg {
            text-align: center; padding: 8px; border-radius: 8px; margin-top: 8px; font-weight: bold; font-size: 13px;
        }
        .status-msg.error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-msg.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-msg.neutral { background: #f5f5f5; color: #333; border: 1px solid #e0e0e0; }

        /* åå–®é è¦½è¡¨æ ¼ */
        .student-table-container {
            max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; margin-top: 15px;
        }
        .student-table { width: 100%; font-size: 13px; border-collapse: collapse; }
        .student-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 1; padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .student-table td { padding: 8px 10px; border-bottom: 1px solid #f1f3f5; }
        .student-table tr.duplicate { background: #fff3cd; }
        .btn-del-student { 
            color: #ccc; background: transparent; border: none; cursor: pointer; font-size: 16px; 
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px;
        }
        .btn-del-student:hover { color: var(--danger); background: #fff5f5; }

        .pref-layout {
            display: grid; 
            grid-template-columns: 200px 1fr; /* é›»è…¦ç‰ˆï¼šå·¦å´å›ºå®š 200pxï¼Œå³å´è‡ªå‹• */
            gap: 30px; 
            align-items: start;
        }
        .header-pulse {
            animation: pulse-seq 0.6s ease-in-out;
        }
        @keyframes pulse-seq {
            0% { transform: scale(1); color: #666; opacity: 1; } /* åŸå§‹ç‹€æ…‹ */
            50% { transform: scale(1.4); color: var(--primary); opacity: 1; } /* ä¸­é»ï¼šæ”¾å¤§è®Šè— */
            100% { transform: scale(1); color: #666; opacity: 1; } /* çµæŸï¼šå›æ­¸åŸå§‹ */
        }
        
        /* å‹•ç•«æ–¹æ ¼ (å„ªåŒ–ç‰ˆ) */
        .anim-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; margin: 0px 15px 0px 15px;
        }
        .anim-container {
            width: 100%; max-width: 180px; /* ç¸®å°æ–¹æ ¼ */
            aspect-ratio: 1; 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; /* æ”¾å¤§é–“è· */
            background: #fff; padding: 15px; border: 1px solid #e9ecef; border-radius: 12px;
        }
        .anim-cell {
            background: #f1f3f5; border-radius: 4px; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; color: #ccc; font-weight: bold;
            aspect-ratio: 1;
        }
        .anim-cell.active {
            background: #90caf9;
            color: #fff;
            transform: scale(1.15);
            box-shadow: 0 0 8px rgba(144, 202, 249, 0.6); /* å»ºè­°ï¼šé™°å½±ä¹Ÿé…åˆèª¿æ•´æˆæ·ºè—è‰²æšˆå…‰ */
        }

        /* Footer æ¨£å¼ */
        .footer {
            /* è®“å¯¬åº¦è¨­å®šèˆ‡ main-card å®Œå…¨ä¸€è‡´ */
            max-width: 1800px; 
            width: 92%;
            margin: 0 auto;    /* ç½®ä¸­ï¼Œç¢ºä¿å·¦å³ç•™ç™½èˆ‡ä¸Šæ–¹ä¸€è‡´ */
            
            background: var(--footer-bg);
            color: #6c757d;
            font-size: 0.9rem;
            padding: 30px 20px;
            text-align: center;
            line-height: 1.6;
            
            /* é›»è…¦ç‰ˆç¶­æŒåœ“è§’è¨­è¨ˆ */
            border-radius: 24px 24px 0 0; 
            margin-top: auto;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03); 
        }
        .footer a { 
            color: var(--text-main); 
            font-weight: 600; 
            position: relative;
            z-index: 1;
        }
        .footer a:hover { text-decoration: underline; }

        .signin-wrapper { 
            display: flex; 
            gap: 30px;     /* å…©æ¬„ä¸­é–“çš„é–“è· */
            width: 100%; 
            justify-content: center; /* ç°½åˆ°è¡¨ç½®ä¸­ */
        }
        .signin-col { flex: 1; }
        .signin-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 11px; 
        }
        .signin-table th, .signin-table td { border: 1px solid #333; padding: 5px 4px; text-align: center; }
        .signin-table td { height: 26px; }
        .signin-table th { background-color: #f0f0f0; font-weight: bold; }
        .col-sign { height: 35px; }

        .notice {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-top: 6px;
        }
        .notice::before {
            content: "â“˜";
            font-size: 13px;
            color: #4b5563;
        }

        /* æ‰‹æ©Ÿç‰ˆè¨­å®š */
        @media (max-width: 768px) {
            .split-layout { grid-template-columns: 1fr; }
            
            /* Footer èˆ‡ Main Card èª¿æ•´ */
            .footer { width: 100%; border-radius: 0; margin-bottom: 0; }
            .main-card { padding: 20px 10px; }
            .card {padding: 15px; }
            body { padding: 0; }
            .pref-layout {
                grid-template-columns: 1fr; /* æ‰‹æ©Ÿç‰ˆï¼šæ”¹ç‚ºå–®æ¬„ï¼Œå‚ç›´å †ç–Š */
                gap: 20px;
            }
            .anim-wrapper {
                margin: 0 auto; 
                width: 100%;
                display: flex;
                justify-content: center;
            }

            /* é‡å°åº•éƒ¨å°èˆªå€çš„æŒ‰éˆ•è¨­å®šæ»¿ç‰ˆï¼Œè€Œä¸æ˜¯å…¨åŸŸæŒ‰éˆ• */
            .action-bar {
                flex-direction: column-reverse; /* æŒ‰éˆ•å‚ç›´æ’åˆ—ï¼Œä¸‹ä¸€æ­¥åœ¨æœ€ä¸Šé¢ */
                gap: 15px;
            }
            .action-bar .btn {
                width: 80%; /* åªæœ‰é€™è£¡çš„æŒ‰éˆ•æœƒè®Š 100% å¯¬ */
                justify-content: center;
            }

            /* Toolbar æ‰‹æ©Ÿç‰ˆå„ªåŒ–ï¼šå‚ç›´å †ç–Š */
            .toolbar {
                flex-direction: column; /* å‚ç›´æ’åˆ— */
                align-items: stretch;   /* å¯¬åº¦æ‹‰æ»¿ */
                gap: 12px;              /* é …ç›®é–“è· */
            }
            
            /* è®“åˆ†éš”ç·šåœ¨æ‰‹æ©Ÿç‰ˆéš±è— */
            .tool-separator { display: none; }

            /* è®“æ¯å€‹å·¥å…·ç¾¤çµ„åœ¨æ‰‹æ©Ÿä¸Šå·¦å³å°é½Š (å·¦é‚Šæ¨™ç±¤ã€å³é‚Šæ§åˆ¶é …) */
            .tool-group {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                border-bottom: 1px dashed #e9ecef; /* åŠ å€‹åˆ†éš”ç·šæ¯”è¼ƒå¥½çœ‹ */
                padding-bottom: 8px;
            }
            .tool-group:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>

<div id="app">
    <div class="main-card">
        <h1>è€ƒå ´åº§ä½éš¨æ©Ÿåˆ†é…ç³»çµ±</h1>

        <!-- æ­¥é©Ÿæ¢ -->
        <div class="stepper">
            <div class="step" :class="{active: step===1, completed: step>1}" @click="step > 1 ? step=1 : null">
                <div class="step-circle">{{ step > 1 ? 'âœ“' : '1' }}</div>
                <div class="step-label">è³‡æ–™æº–å‚™</div>
            </div>
            <div class="step" :class="{active: step===2, completed: step>2}" @click="step > 2 ? step=2 : null">
                <div class="step-circle">{{ step > 2 ? 'âœ“' : '2' }}</div>
                <div class="step-label">å ´åœ°ä½ˆå±€</div>
            </div>
            <div class="step" :class="{active: step===3, completed: step>3}" @click="step > 3 ? step=3 : null">
                <div class="step-circle">{{ step > 3 ? 'âœ“' : '3' }}</div>
                <div class="step-label">åˆ†é…è¦å‰‡</div>
            </div>
            <div class="step" :class="{active: step===4}" @click="step > 4 ? step=4 : null">
                <div class="step-circle">4</div>
                <div class="step-label">é è¦½èˆ‡åŒ¯å‡º</div>
            </div>
        </div>

        <transition name="fade" mode="out-in">
            <!-- Step 1: è³‡æ–™æº–å‚™ -->
            <div v-if="step === 1" key="step1" class="split-layout">
                <!-- å·¦ï¼šè€ƒè©¦è³‡è¨Š -->
                <div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">è€ƒè©¦è³‡è¨Šè¨­å®š</span></div>
                        <div class="form-group">
                            <label class="form-label">å­¸æœŸ (Semester)</label>
                            <input type="text" class="form-control" v-model="examInfo.semester" placeholder="ä¾‹å¦‚ï¼š114-1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è€ƒè©¦åç¨± (Exam Name)</label>
                            <input type="text" class="form-control" v-model="examInfo.title" placeholder="ä¾‹å¦‚ï¼šç¨‹å¼è¨­è¨ˆæœŸä¸­è€ƒ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è€ƒè©¦æ—¥æœŸ (Exam Date)</label>
                            <input type="date" class="form-control" v-model="examInfo.date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è€ƒè©¦æ™‚é–“ (Exam Time)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="time" class="form-control" v-model="examInfo.startTime" style="flex: 1;">
                                <span style="font-weight:bold; color:var(--secondary);">è‡³</span>
                                <input type="time" class="form-control" v-model="examInfo.endTime" style="flex: 1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‚™è¨» (Remarks)</label>
                            <textarea class="form-control" v-model="examInfo.note" placeholder="ï¼ˆé€™éƒ¨åˆ†ç›®å‰æ²’æœ‰åŠŸèƒ½ï¼Œä¸ç”¨å¡«ï¼‰"></textarea>
                        </div>
                        <div class="notice" style="margin: 0px 0px 0px 0px;">
                            æ­¤è™•è¨­å®šçš„è³‡è¨Šå°‡æœƒé¡¯ç¤ºåœ¨æœ€çµ‚åŒ¯å‡ºçš„æª”æ¡ˆä¸­ã€‚
                        </div>
                    </div>
                </div>

                <!-- å³ï¼šåå–®ä¸Šå‚³ -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">è€ƒç”Ÿåå–®ç®¡ç†</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: stretch;">
                        
                        <div style="display: flex; flex-direction: column;">
                            <label class="form-label">æ–¹æ³•ä¸€ï¼šæ•´æ‰¹åŒ¯å…¥åå–® <span class="badge badge-primary" style="margin-left: 3px;">CSV / XLSX</span></label>
                            
                            <div class="upload-zone" 
                                 :class="{'drag-active': isDragActive}"
                                 @click="$refs.fileInput.click()"
                                 @dragover.prevent="isDragActive=true"
                                 @dragleave.prevent="isDragActive=false"
                                 @drop.prevent="handleDrop"
                                 style="padding: 20px; margin-bottom: 0; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                <input type="file" ref="fileInput" @change="handleFileSelect" accept=".csv, .xlsx, .xls" style="display:none" multiple>
                                <p style="font-size: 3rem; margin: 0 0 10px 0;">ğŸ“‚</p>
                                <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                                    <!-- <span style="font-size: 2rem;">ğŸ“‚</span> -->
                                    <div style="text-align:left;">
                                        <span style="font-weight:600; display:block;">é»æ“Š æˆ– æ‹–æ›³æª”æ¡ˆè‡³æ­¤</span>
                                        <span style="font-size:12px; color:#666;">æ”¯æ´ CSV æˆ– Excel (.xlsx)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column;">
                            <label class="form-label">æ–¹æ³•äºŒï¼šæ‰‹å‹•æ–°å¢è€ƒç”Ÿ</label>
                            
                            <div style="background: rgb(250, 251, 252); padding: 20px; border-radius: 12px; border: 2px dashed rgb(222, 226, 230); flex: 1 1 0%; display: flex; flex-direction: column; justify-content: center;">
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <input type="text" class="form-control" v-model="manualInput.sID" placeholder="å­¸è™Ÿ (ID)">
                                    <input type="text" class="form-control" v-model="manualInput.Name" placeholder="å§“å (Name)">
                                    <button class="quiet-btn btn-primary" @click="addManualStudent" style="width: 100%;">æ–°å¢</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hint-box">
                        <span>â“˜</span>
                        <div>
                            <strong>ã€Œæ•´æ‰¹åŒ¯å…¥åå–®ã€æ ¼å¼è¦æ±‚ï¼š</strong><br>
                            1. ç¬¬ä¸€æ¬„ç‚º<strong>å­¸è™Ÿ</strong>ã€ç¬¬äºŒæ¬„ç‚º<strong>å§“å</strong>ã€‚<br>
                            2. ç³»çµ±æœƒä»¥ã€Œå­¸è™Ÿã€ã€ã€ŒIDã€ç­‰å­—æ¨£åˆ¤æ–·ï¼Œè‡ªå‹•å¿½ç•¥æ¨™é¡Œåˆ—ã€‚
                        </div>
                    </div>
                    <div class="hint-box">
                        <span>â“˜</span>
                        <div>
                            <strong>ã€Œæ‰‹å‹•æ–°å¢è€ƒç”Ÿã€æç¤ºï¼š</strong><br>
                            é©ç”¨æ–¼è£œç™»å°‘é‡è€ƒç”Ÿï¼Œè¼¸å…¥å¾Œé»æ“Šã€Œæ–°å¢ã€å³å¯åŠ å…¥åå–®ã€‚
                        </div>
                    </div>

                    <div v-if="students.length">
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px dashed #e9ecef;"></div>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px;">
                            <div style="display:flex; align-items:center; gap: 10px;">
                                <span style="font-weight:bold; font-size:18px;">åå–®é è¦½</span>
                                <span class="badge badge-success">å…± {{ students.length }} äºº</span>
                                <span v-if="duplicateCount > 0" class="badge badge-warning">âš ï¸ {{ duplicateCount }} é‡è¤‡</span>
                            </div>

                            <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div class="btn-pill-group">
                                    <button class="btn-pill" :class="{active: sortType==='import'}" @click="sortStudents('import')">åŒ¯å…¥é †åº</button>
                                    <button class="btn-pill" :class="{active: sortType==='asc'}" @click="sortStudents('asc')">å­¸è™Ÿ A-Z æ’åº</button>
                                    <button class="btn-pill" :class="{active: sortType==='desc'}" @click="sortStudents('desc')">å­¸è™Ÿ Z-A æ’åº</button>
                                    <button class="btn-pill" :class="{active: sortType==='manual'}" @click="sortType='manual'">æ‰‹å‹•æ’åº</button>
                                </div>

                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-action-danger" @click="removeDuplicates" v-if="duplicateCount > 0">Ã— ç§»é™¤é‡è¤‡</button>
                                    <button class="btn-action-danger" @click="clearStudents">Ã— æ¸…ç©ºåå–®</button>
                                </div>
                            </div>
                        </div>

                        <div class="student-table-container">
                            <table class="student-table">
                                <thead>
                                    <tr>
                                        <th width="15%">#</th>
                                        <th width="30%">å­¸è™Ÿ</th>
                                        <th width="30%">å§“å</th>
                                        <th width="25%">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(s, i) in students" :key="s._oid">
                                        <td>
                                            {{ i + 1 }}
                                            <span v-if="s.isDuplicate" title="å­¸è™Ÿé‡è¤‡" style="font-size:12px; cursor:help; margin-left: 2px;">âš ï¸</span>
                                        </td>
                                        <td><input type="text" class="table-input" v-model="s.sID" @change="onStudentUpdate"></td>
                                        <td><input type="text" class="table-input" v-model="s.Name" @change="onStudentUpdate"></td>
                                        <td>
                                            <div style="display:flex; gap:5px; justify-content: flex-start;">
                                                <button class="btn-del-student" @click="removeStudent(i)" title="åˆªé™¤è€ƒç”Ÿ">Ã—</button>
                                                <template v-if="sortType === 'manual'">
                                                    <button class="btn-sort" @click="moveStudent(i, -1)" :disabled="i===0" title="æå‡è€ƒç”Ÿé †åº">â–²</button>
                                                    <button class="btn-sort" @click="moveStudent(i, 1)" :disabled="i===students.length-1" title="èª¿é™è€ƒç”Ÿé †åº">â–¼</button>
                                                </template>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="notice" style="margin: 20px 0px 0px 0px;">
                            æ­¤è™•æœƒå„²å­˜æ‚¨è¨­å®šçš„åå–®é †åºã€‚
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: å ´åœ°ä½ˆå±€ -->
            <div v-if="step === 2" key="step2" class="split-layout">
                <!-- å·¦ï¼šé¸æ“‡è€ƒå ´ -->
                <div class="card" style="height: fit-content;">
                    <div class="card-header"><span class="card-title">è€ƒå ´å•Ÿç”¨</span></div>
                    <div style="font-size:13px; color:var(--text-sub); margin-bottom:15px;">
                        å‹¾é¸æœ¬æ¬¡è€ƒè©¦è¦ä½¿ç”¨çš„è€ƒå ´ï¼Œä¸¦å¯åœ¨å³å´ç·¨è¼¯è©³ç´°ä½ˆå±€ã€‚
                    </div>
                    
                    <div v-for="(room, key) in rooms" :key="key" 
                        style="display:flex; align-items:center; padding:10px; border-radius:8px; margin-bottom:8px; cursor:pointer;"
                        @click="room.selected = !room.selected"> 
                        
                        <input type="checkbox" v-model="room.selected" @click.stop style="transform:scale(1.2); margin-right:10px;">
                        
                        <div style="flex:1; min-width: 0;">
                            
                            <div style="font-weight:600; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                 :title="room.name">
                                {{ room.name }}
                            </div>
                            
                            <div style="font-size:12px; color:var(--text-sub);">
                                å¯ç”¨åº§ä½ï¼š{{ getRoomAvailable(key) }} å€‹
                            </div>
                        </div>
                        
                        <div v-if="currentRoomKey===key" style="font-size:12px; color:var(--primary); font-weight:bold; white-space: nowrap; margin-left: 8px;">
                            ç·¨è¼¯ä¸­
                        </div>
                    </div>

                    <div style="margin-top:15px; padding-top:15px; border-top:1px solid #e9ecef;">
                        <div class="stats-chip-container">
                            <div class="stats-chip">
                                <span class="dot blue"></span> 
                                ç¸½å¯ç”¨åº§ä½ï¼š{{ totalAvailable }} å€‹
                            </div>
                            <div class="stats-chip">
                                <span class="dot green"></span> 
                                ç¸½è€ƒç”Ÿæ•¸ï¼š{{ students.length }} äºº
                            </div>
                            <div v-if="totalAvailable < students.length" class="stats-chip" style="background:var(--danger-light); color:var(--danger); border-color:var(--danger-light);">
                                <span class="dot red"></span> 
                                å°šç¼º {{ students.length - totalAvailable }} å€‹åº§ä½
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ï¼šè€ƒå ´ä½ˆå±€è¨­è¨ˆ (PowerPoint Style) -->
                <div style="width:100%; min-width: 0;"> <!-- min-width: 0 is important for flex/grid child overflow -->
                    <!-- ä¸Šæ–¹ç¸®åœ–åˆ— -->
                    <div class="room-slides-container">
                        <div v-for="(room, key) in rooms" :key="key" 
                            class="room-slide" :class="{active: currentRoomKey === key}"
                            @click="currentRoomKey = key">
                            <div class="room-slide-info">
                                <h4>{{ room.name }}</h4>
                                <div class="room-slide-stats">{{ room.rowSpecs.filter(x=>x).length }} è¡Œ Ã— {{ room.colSpecs.filter(x=>x).length }} åˆ—</div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="badge" :class="room.selected ? 'badge-success' : ''">{{ room.selected ? 'å•Ÿç”¨' : 'æœªå•Ÿç”¨' }}</span>
                                <small style="color:#aaa;">#{{ room.order }}</small>
                            </div>
                        </div>
                        <div class="room-slide-add" @click="addCustomRoom" title="æ–°å¢è‡ªè¨‚è€ƒå ´">
                            <span style="font-size: 24px; line-height: 1; font-weight: 300;">+</span>
                            <span style="font-size: 13px; font-weight: bold;">æ–°å¢è‡ªè¨‚è€ƒå ´</span>
                        </div>
                    </div>

                    <!-- ä¸»ç·¨è¼¯å€ -->
                    <div class="card" v-if="currentRoomKey">
                        <div class="card-header"><span class="card-title">è€ƒå ´ç´°ç¯€ä½ˆå±€</span></div>
                        <div class="card-header-without-border">
                            <div style="display:flex; flex-wrap: wrap; align-items:center; gap:10px; width:100%;">

                                <span class="tool-label" style="font-size: 14px;">è€ƒå ´åç¨±</span>

                                <input type="text" v-model="rooms[currentRoomKey].name" 
                                    class="form-control" style="font-weight:bold; font-size:16px; width:auto; flex:1; min-width: 150px;">

                                <button class="btn btn-outline-danger" 
                                        @click="removeRoom(currentRoomKey)" 
                                        title="åˆªé™¤æ­¤è€ƒå ´"
                                        style="padding: 10px 16px; border-radius: 8px; white-space: nowrap; font-weight: bold;">
                                    Ã— åˆªé™¤è€ƒå ´
                                </button>

                            </div>
                        </div>

                        <!-- å·¥å…·åˆ— -->
                        <div class="toolbar">

                            <div class="tool-group">
                                <span class="tool-label">ç›´è¡Œç·¨è™Ÿæ–¹å‘</span>
                                <button class="btn btn-sm btn-primary" @click="toggleNumberingType(currentRoomKey)" title="åˆ‡æ›ç›´è¡Œç´¢å¼•å€¼ç·¨è™Ÿæ–¹å‘">
                                    {{ rooms[currentRoomKey].numberingType==='normal' ? '1â­¢N' : 'Nâ­ 1' }}
                                </button>
                            </div>
                            
                            <div class="tool-separator"></div>

                            <div class="tool-group">
                                <span class="tool-label">ç›´è¡Œ (Cols)</span>
                                <div style="display:flex; align-items:center; background:white; border:1px solid #dee2e6; border-radius:6px; padding:2px;">
                                    <button class="btn btn-sm"  title="åˆªé™¤ç›´è¡Œ"
                                            style="border:none; background:transparent; padding: 2px 8px;" 
                                            @click="modifyLayout(currentRoomKey, 'delCol')">â–</button>
                                    
                                    <span class="tool-counter">{{ rooms[currentRoomKey].colSpecs.length }}</span>
                                    
                                    <button class="btn btn-sm"  title="æ–°å¢ç›´è¡Œ"
                                            style="border:none; background:transparent; padding: 2px 8px;" 
                                            @click="modifyLayout(currentRoomKey, 'addCol')">â•</button>
                                </div>
                            </div>

                            <div class="tool-separator"></div>

                            <div class="tool-group">
                                <span class="tool-label">æ©«åˆ— (Rows)</span>
                                <div style="display:flex; align-items:center; background:white; border:1px solid #dee2e6; border-radius:6px; padding:2px;">
                                    <button class="btn btn-sm" title="åˆªé™¤æ©«åˆ—"
                                            style="border:none; background:transparent; padding: 2px 8px;" 
                                            @click="modifyLayout(currentRoomKey, 'delRow')">â–</button>
                                    
                                    <span class="tool-counter">{{ rooms[currentRoomKey].rowSpecs.length }}</span>
                                    
                                    <button class="btn btn-sm" title="æ–°å¢æ©«åˆ—"
                                            style="border:none; background:transparent; padding: 2px 8px;" 
                                            @click="modifyLayout(currentRoomKey, 'addRow')">â•</button>
                                </div>
                            </div>

                            <div class="tool-separator"></div>
                            
                            <div class="tool-group">
                                <span class="tool-label">å…¥å£ä½ç½®</span>
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-sm btn-outline" @click="toggleEntrance(currentRoomKey)" title="åˆ‡æ›å…¥å£ä½ç½®ï¼ˆå·¦å³ï¼‰">
                                        â†”ï¸ {{ rooms[currentRoomKey].entrance==='right' ? 'å³å´' : 'å·¦å´' }}
                                    </button>
                                    <button class="btn btn-sm btn-outline" @click="toggleEntrancePos(currentRoomKey)" title="åˆ‡æ›å…¥å£ä½ç½®ï¼ˆå‰å¾Œï¼‰">
                                        â†•ï¸ {{ rooms[currentRoomKey].entrancePos==='front' ? 'å‰æ–¹' : 'å¾Œæ–¹' }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ç¶²æ ¼ç·¨è¼¯å™¨ -->
                        <div class="grid-editor-wrapper">
                            <transition name="room-switch" mode="out-in">
                                <div :key="currentRoomKey" style="display: inline-block; min-width: 100%;">
                                    <!-- å…¥å£æ¨™ç¤º (å‰) -->
                                    <div v-if="rooms[currentRoomKey].entrancePos === 'front'" 
                                        style="text-align:right; color:var(--danger); font-size:12px; margin:15px; font-weight:bold;"
                                        :style="{textAlign: rooms[currentRoomKey].entrance === 'left' ? 'left' : 'right'}">
                                        {{ rooms[currentRoomKey].entrance === 'left' ? 'â¬… å…¥å£ä½ç½®ï¼ˆå‰ï¼‰' : 'å…¥å£ä½ç½®ï¼ˆå‰ï¼‰ â®•' }}
                                    </div>

                                    <div class="grid-layout" :style="getGridStyle(currentRoomKey)">
                                        <div></div>
                                        <!-- è¡Œæ¨™é¡Œ (é»æ“Šåˆ‡æ›èµ°é“) -->
                                        <div v-for="(h, idx) in rooms[currentRoomKey].headers" :key="'h-'+idx"
                                            class="col-header" 
                                            :class="[
                                                { 'aisle-label': h==='èµ°é“' },
                                                getAnimClass(currentRoomKey, 'col', idx)
                                            ]"
                                            @click="toggleColType(currentRoomKey, idx)"
                                            title="é»æ“Šåˆ‡æ›ï¼šåº§ä½ / èµ°é“">
                                            <span :id="'col-h-'+currentRoomKey+'-'+idx" style="display: block;">
                                                {{ h }}
                                            </span>
                                        </div>
                                        <div></div>

                                        <template v-for="(rLabel, rIdx) in rooms[currentRoomKey].rowHeaders" :key="'r-'+rIdx">
                                            <!-- åˆ—æ¨™é¡Œ (å·¦) -->
                                            <div class="row-header" 
                                                :class="getAnimClass(currentRoomKey, 'row', rIdx)"
                                                @click="toggleRowType(currentRoomKey, rIdx)" 
                                                title="é»æ“Šåˆ‡æ›ï¼šåº§ä½ / èµ°é“">
                                                {{ rLabel }}
                                            </div>
                                            
                                            <!-- åº§ä½ -->
                                            <div v-for="(colSpec, cIdx) in rooms[currentRoomKey].colSpecs" :key="'s-'+rIdx+'-'+cIdx"
                                                class="seat" title="é»æ“Šåˆ‡æ›ï¼šç¦ç”¨ç‹€æ…‹"
                                                :class="[
                                                    {'aisle': colSpec===0 || rooms[currentRoomKey].rowSpecs[rIdx]===0},
                                                    {'blocked': getSeat(currentRoomKey, rIdx, cIdx).type === 2},
                                                    getAnimClass(currentRoomKey, 'row', rIdx),
                                                    getAnimClass(currentRoomKey, 'col', cIdx)
                                                ]"
                                                @click="(colSpec===1 && rooms[currentRoomKey].rowSpecs[rIdx]===1) ? toggleSeat(currentRoomKey, rIdx, cIdx) : null">
                                                <span v-if="getSeat(currentRoomKey, rIdx, cIdx).type===2">âœ•</span>
                                                <span v-else-if="colSpec===1 && rooms[currentRoomKey].rowSpecs[rIdx]===1" class="seat-coord">
                                                    {{ getSeat(currentRoomKey, rIdx, cIdx).coordStr }}
                                                </span>
                                            </div>

                                            <!-- åˆ—æ¨™é¡Œ (å³) -->
                                            <div class="row-header" 
                                                :class="getAnimClass(currentRoomKey, 'row', rIdx)"
                                                @click="toggleRowType(currentRoomKey, rIdx)">
                                                {{ rLabel }}
                                            </div>
                                        </template>
                                    </div>

                                    <!-- å…¥å£æ¨™ç¤º (å¾Œ) -->
                                    <div v-if="rooms[currentRoomKey].entrancePos === 'back'" 
                                        style="text-align:right; color:var(--danger); font-size:12px; margin:15px; font-weight:bold;"
                                        :style="{textAlign: rooms[currentRoomKey].entrance === 'left' ? 'left' : 'right'}">
                                        {{ rooms[currentRoomKey].entrance === 'left' ? 'â¬… å…¥å£ä½ç½®ï¼ˆå¾Œï¼‰' : 'å…¥å£ä½ç½®ï¼ˆå¾Œï¼‰ â®•' }}
                                    </div>
                                </div>
                            </transition>
                        </div>

                        <!-- æ“ä½œæç¤º -->
                        <div class="hint-box">
                            <span>â“˜</span>
                            <div>
                                <strong>ã€Œè€ƒå ´ç´°ç¯€ä½ˆå±€ã€æ“ä½œæç¤ºï¼š</strong><br>
                                1. ç´°ç¯€ä½ˆå±€æ“ä½œä¸­çš„ã€Œç›´è¡Œ (Cols)ã€èˆ‡ã€Œæ©«åˆ— (Rows)ã€æ•¸å­—åŒ…å«èµ°é“ã€‚<br>
                                2. æ–°å¢æˆ–åˆªæ¸›è¡Œåˆ—æ™‚ï¼Œæœƒå¾ç´¢å¼•å€¼è¼ƒå¤§çš„ä¸€ç«¯å®Œæˆæ“ä½œã€‚å¯ä»¥èª¿æ•´ã€Œç›´è¡Œç·¨è™Ÿæ–¹å‘ã€ä¾†æ”¹è®Šç´¢å¼•å€¼èµ·å§‹ä½ç½®ã€‚<br>
                                3. é»æ“Šä¸Šæ–¹ã€Œè¡Œç´¢å¼•å€¼ã€æˆ–å…©å´ã€Œåˆ—ç´¢å¼•å€¼ã€å¯å°‡è©²è¡Œ/åˆ—è¨­ç½®ç‚ºèµ°é“ã€‚<br>
                                4. é»æ“Šå„åˆ¥åº§ä½å¯å°‡å…¶è¨­ç½®ç‚ºç¦ç”¨ç‹€æ…‹ï¼ˆï¼¸ï¼‰ã€‚ç¦ç”¨ç‹€æ…‹ä¸‹ï¼Œè©²åº§ä½ä¸æœƒè¢«åˆ†é…åˆ°è€ƒç”Ÿã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: åˆ†é…è¦å‰‡ -->
            <div v-if="step === 3" key="step3" class="split-layout">
                <!-- å·¦ï¼šæ•™å®¤é è¦½èˆ‡é…é¡ -->
                <div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">è€ƒå ´é †åºèˆ‡é…é¡ç®¡ç†</span></div>
                        
                        <div v-if="assignConfig.distribute === 'auto'">
                            <div class="form-group">
                                <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:10px; color:var(--text-sub);">
                                    <span style="margin-left: 12px;">è€ƒå ´é †åº / åç¨±</span>
                                    <span style="margin-right: 10px;">é è¨ˆåˆ†é…</span>
                                </div>
                                <div v-for="(key, idx) in sortedRoomKeys" :key="'quota-'+key" 
                                    style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #e9ecef;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <div style="display:flex; flex-direction:column; gap:2px;">
                                            <button class="btn-sort" @click="moveOrder(key, -1)" :disabled="idx===0" title="æå‡è€ƒå ´é †åº">â–²</button>
                                            <button class="btn-sort" @click="moveOrder(key, 1)" :disabled="idx===sortedRoomKeys.length-1" title="èª¿é™è€ƒå ´é †åº">â–¼</button>
                                        </div>
                                        
                                        <div style="flex:1; min-width: 0;"> <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <div style="min-width: 0;"> <div style="font-weight:bold; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                         :title="rooms[key].name">
                                                        {{ rooms[key].name }}
                                                    </div>
                                                    <div style="font-size:11px; color:#999;">å®¹é‡ï¼š{{ getRoomAvailable(key) }}</div>
                                                </div>
                                                <div style="font-size:12px; text-align:right; white-space:nowrap; margin-left: 10px;">
                                                    {{ getAutoCount(key) }} äºº
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-else class="status-msg success">
                                âœ… ç³»çµ±å°‡ä¾è€ƒå ´é †åºè‡ªå‹•å¡«æ»¿åº§ä½
                            </div>
                        </div>

                        <div v-else>
                            <div class="form-group">
                                <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:10px; color:var(--text-sub);">
                                    <span style="margin-left: 12px;">è€ƒå ´é †åº / åç¨±</span>
                                    <span style="margin-right: 10px;">è‡ªè¡Œåˆ†é…</span>
                                </div>
                                <div v-for="(key, idx) in sortedRoomKeys" :key="'quota-'+key" 
                                    style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #e9ecef;">
                                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                                        <!-- æ’åºæŒ‰éˆ• -->
                                        <div style="display:flex; flex-direction:column; gap:2px;">
                                            <button class="btn-sort" @click="moveOrder(key, -1)" :disabled="idx===0" title="æå‡è€ƒå ´é †åº">â–²</button>
                                            <button class="btn-sort" @click="moveOrder(key, 1)" :disabled="idx===sortedRoomKeys.length-1" title="èª¿é™è€ƒå ´é †åº">â–¼</button>
                                        </div>
                                        <div style="flex:1; min-width: 0;"> <div style="font-weight:bold; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                 :title="rooms[key].name">
                                                {{ rooms[key].name }}
                                            </div>
                                            <div style="font-size:11px; color:#999;">å¯ç”¨åº§ä½ï¼š{{ getRoomAvailable(key) }} å€‹</div>
                                        </div>
                                    </div>
                                    
                                    <div v-if="key !== lastActiveRoomKey" style="display:flex; align-items:center; justify-content: flex-end; gap:8px;">
                                        <label style="font-size:12px;">æŒ‡å®šäººæ•¸ï¼š</label>
                                        <input type="number" v-model.number="roomQuotas[key]" min="0" :max="getRoomAvailable(key)"
                                            @input="checkQuota(key)"
                                            class="form-control" style="width:80px; padding:4px 8px; height:auto; text-align: right;">
                                            <label style="font-size:12px;">äºº</label>
                                    </div>
                                    <div v-else style="font-size:12px; text-align:right;">
                                        è‡ªå‹•è¨ˆç®—å‰©é¤˜äººæ•¸ï¼š{{ autoAllocatedCount }} äºº
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="isOverloaded" class="status-msg error">
                                âš ï¸ äººæ•¸è¶…å‡ºç¸½å®¹é‡ï¼è«‹å¢åŠ è€ƒå ´æˆ–èª¿æ•´äººæ•¸
                            </div>
                            <div v-else class="status-msg success">
                                âœ… é…é¡è¨­å®šæ­£å¸¸
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ï¼šè¦å‰‡è¨­å®š -->
                <div class="card">
                    <div class="card-header"><span class="card-title">åˆ†é…é‚è¼¯è¨­å®š</span></div>

                    <div class="form-group">
                        <label class="form-label">1. åˆ†æµç­–ç•¥ï¼ˆå¦‚ä½•åˆ†é…å„è€ƒå ´äººæ•¸ï¼Ÿï¼‰</label>
                        <div class="btn-pill-group">
                            <button class="btn-pill" :class="{active: assignConfig.distribute==='auto'}" @click="assignConfig.distribute='auto'">
                                ğŸŒŠ è‡ªå‹•å¡«æ»¿ (Auto-Fill)
                            </button>
                            <button class="btn-pill" 
                                    :class="{active: assignConfig.distribute==='sequential'}" 
                                    @click="sortedRoomKeys.length > 1 ? assignConfig.distribute='sequential' : null"
                                    :disabled="sortedRoomKeys.length <= 1"
                                    :title="sortedRoomKeys.length <= 1 ? 'å–®ä¸€è€ƒå ´ç„¡éœ€åˆ†æ®µ' : ''">
                                ğŸ–ï¸ æ‰‹å‹•æŒ‡å®š (Manual)
                            </button>
                        </div>
                        
                        <div class="option-desc" v-if="assignConfig.distribute==='auto'">
                            è‡ªå‹•å¡«æ»¿ï¼šç³»çµ±å°‡ä¾ç…§ã€Œè³‡æ–™æº–å‚™ã€éšæ®µè¨­å®šçš„åå–®é †åºï¼Œå„ªå…ˆå¡«æ»¿ç¬¬ä¸€é–“è€ƒå ´ï¼Œå‰©é¤˜äººæ•¸å†å¡«å…¥ä¸‹ä¸€é–“ã€‚
                        </div>
                        <div class="option-desc" v-else>
                            æ‰‹å‹•æŒ‡å®šï¼šè‡ªè¡Œæ±ºå®šæ¯é–“è€ƒå ´è¦åˆ†é…å¤šå°‘è€ƒï¼ˆä¾‹å¦‚ï¼šç¬¬ä¸€é–“ 50 äººï¼Œç¬¬äºŒé–“ 30 äººï¼‰ã€‚
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px dashed #e9ecef; margin:20px 0;">

                    <div class="form-group">
                        <label class="form-label">2. å…¥åº§ç­–ç•¥ï¼ˆé€²å…¥è€ƒå ´å¾Œæ€éº¼åˆ†é…åº§ä½ï¼Ÿï¼‰</label>
                        <div class="btn-pill-group">
                            <button class="btn-pill" :class="{active: assignConfig.seat==='random'}" @click="assignConfig.seat='random'">
                                ğŸ² éš¨æ©Ÿå…¥åº§ (Random)
                            </button>
                            <button class="btn-pill" :class="{active: assignConfig.seat==='sequential'}" @click="assignConfig.seat='sequential'">
                                ğŸ†” ä¾åºå…¥åº§ (Sequential)
                            </button>
                        </div>
                        <div class="option-desc" v-if="assignConfig.seat==='random'">
                            éš¨æ©Ÿå…¥åº§ï¼šè€ƒç”Ÿåœ¨è©²è€ƒå ´å…§çš„åº§ä½ä½ç½®æ˜¯éš¨æ©Ÿçš„ã€‚
                        </div>
                        <div class="option-desc" v-else>
                            ä¾åºå…¥åº§ï¼šä¾ç…§ã€Œè³‡æ–™æº–å‚™ã€éšæ®µè¨­å®šçš„åå–®é †åºå¡«æ»¿åº§ä½ã€‚
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px dashed #e9ecef; margin:20px 0;">

                    <div class="form-group">
                        <label class="form-label">3. å¡«ç©ºé †åºåå¥½</label>
                        <!-- æ‹†åˆ†ç‚ºå·¦å³ä½ˆå±€ï¼šå·¦é‚Šå‹•ç•«ï¼Œå³é‚Šé¸é … -->
                        <div class="pref-layout">
                            <!-- å‹•ç•«å€ -->
                            <div class="anim-wrapper">
                                <div class="anim-container">
                                    <!-- å…± 25 æ ¼ -->
                                    <div v-for="n in 25" :key="n" 
                                        class="anim-cell" 
                                        :class="{active: getAnimOrder(n-1) < animStep}">
                                        {{ getAnimOrder(n-1) + 1 }}
                                    </div>
                                </div>
                                <div style="font-size:12px; margin-top:10px; color:#666;">å¡«ç©ºé †åºæ¼”ç¤º</div>
                            </div>

                            <div style="display:flex; flex-direction: column; gap: 15px;">
                                <div>
                                    <label style="font-size:12px; display:block; margin-bottom:6px; font-weight:bold;">A. å„ªå…ˆå¡«æ»¿æ–¹å‘</label>
                                    <div class="btn-pill-group">
                                        <button class="btn-pill" :class="{active: fillPrefs.priority==='row'}" @click="fillPrefs.priority='row'">å…ˆå¡«æ»¿æ©«åˆ— (Row-first priority)</button>
                                        <button class="btn-pill" :class="{active: fillPrefs.priority==='col'}" @click="fillPrefs.priority='col'">å…ˆå¡«æ»¿ç›´è¡Œ (Column-first priority)</button>
                                    </div>
                                    <div class="option-desc">
                                        {{ fillPrefs.priority==='row' ? 'å…ˆå¡«æ»¿æ©«åˆ—ï¼šåæ»¿ç¬¬ä¸€æ©«æ’å¾Œï¼Œæ‰åç¬¬äºŒæ©«æ’ã€‚' : 'å…ˆå¡«æ»¿ç›´è¡Œï¼šåæ»¿ç¬¬ä¸€ç›´è¡Œå¾Œï¼Œæ‰åç¬¬äºŒç›´è¡Œã€‚' }}
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size:12px; display:block; margin-bottom:6px; font-weight:bold;">B. å‰å¾Œé †åº</label>
                                    <div class="btn-pill-group">
                                        <button class="btn-pill" :class="{active: fillPrefs.rowDir==='forward'}" @click="fillPrefs.rowDir='forward'">ç”±å‰è‡³å¾Œ (Front-to-back)</button>
                                        <button class="btn-pill" :class="{active: fillPrefs.rowDir==='backward'}" @click="fillPrefs.rowDir='backward'">ç”±å¾Œè‡³å‰ (Back-to-front)</button>
                                    </div>
                                    <div class="option-desc">
                                        {{ fillPrefs.rowDir==='forward' ? 'ç”±å‰è‡³å¾Œï¼šè¦–è¦ºä¸Šå¾å‰é¢å¡«åˆ°å¾Œé¢ã€‚' : 'ç”±å¾Œè‡³å‰ï¼šè¦–è¦ºä¸Šå¾å¾Œé¢å¡«åˆ°å‰é¢ã€‚' }}
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size:12px; display:block; margin-bottom:6px; font-weight:bold;">C. å·¦å³é †åº</label>
                                    <div class="btn-pill-group">
                                        <button class="btn-pill" :class="{active: fillPrefs.colDir==='left_right'}" @click="fillPrefs.colDir='left_right'">ç”±å·¦è‡³å³ (Left-to-right)</button>
                                        <button class="btn-pill" :class="{active: fillPrefs.colDir==='right_left'}" @click="fillPrefs.colDir='right_left'">ç”±å³è‡³å·¦ (Right-to-left)</button>
                                    </div>
                                    <div class="option-desc">
                                        {{ fillPrefs.colDir==='left_right' ? 'ç”±å·¦è‡³å³ï¼šè¦–è¦ºä¸Šå¾å·¦é‚Šå¡«åˆ°å³é‚Šã€‚' : 'ç”±å³è‡³å·¦ï¼šè¦–è¦ºä¸Šå¾å³é‚Šå¡«åˆ°å·¦é‚Šã€‚' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: é è¦½èˆ‡åŒ¯å‡º -->
            <div v-if="step === 4 && !isReloading" key="step4" class="split-layout">
                <!-- å·¦ï¼šçµæœè³‡è¨Š -->
                <div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">åˆ†é…é‚è¼¯</span></div>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label class="form-label">åˆ†æµç­–ç•¥ èˆ‡ å…¥åº§ç­–ç•¥ï¼š</label>
                                <div style="display:flex; gap:8px;">
                                    <span style="background:#f8f9fa; padding:5px 10px; border-radius:6px; border:1px solid #dee2e6; color:#555; font-size:13px; display:flex; align-items:center; gap:4px;">
                                        {{ assignConfig.distribute==='auto' ? 'ğŸŒŠ è‡ªå‹•å¡«æ»¿' : 'ğŸ–ï¸ æ‰‹å‹•æŒ‡å®š' }}
                                    </span>
                                    <span style="background:#f8f9fa; padding:5px 10px; border-radius:6px; border:1px solid #dee2e6; color:#555; font-size:13px; display:flex; align-items:center; gap:4px;">
                                        {{ assignConfig.seat==='random' ? 'ğŸ² éš¨æ©Ÿå…¥åº§' : 'ğŸ†” ä¾åºå…¥åº§' }}
                                    </span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label">å¡«ç©ºé †åºåå¥½ï¼š</label>
                                <div style="display:flex; gap:6px; flex-wrap:wrap; font-size:13px;">
                                    <span style="background:#f8f9fa; padding:5px 10px; border-radius:6px; border:1px solid #dee2e6; color:#555;">
                                        {{ fillPrefs.priority==='row' ? 'å…ˆå¡«æ»¿æ©«åˆ—' : 'å…ˆå¡«æ»¿ç›´è¡Œ' }}
                                    </span>
                                    <span style="background:#f8f9fa; padding:5px 10px; border-radius:6px; border:1px solid #dee2e6; color:#555;">
                                        {{ fillPrefs.rowDir==='forward' ? 'ç”±å‰è‡³å¾Œ' : 'ç”±å¾Œè‡³å‰' }}
                                    </span>
                                    <span style="background:#f8f9fa; padding:5px 10px; border-radius:6px; border:1px solid #dee2e6; color:#555;">
                                        {{ fillPrefs.colDir==='left_right' ? 'ç”±å·¦è‡³å³' : 'ç”±å³è‡³å·¦' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title">åˆ†é…çµæœçµ±è¨ˆ</span></div>
                        <div class="form-group">
                            <div class="stats-chip-container">
                                <div class="stats-chip"><span class="dot blue"></span> å¯¦éš›åˆ†é…åº§ä½ï¼š{{ totalAssigned }} å€‹</div>
                                <div class="stats-chip"><span class="dot green"></span> ç¸½è€ƒç”Ÿæ•¸ï¼š{{ students.length }} äºº</div>
                                <div class="stats-chip"><span class="dot black"></span> ä½¿ç”¨è€ƒå ´ï¼š{{ sortedRoomKeys.length }} é–“</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:15px; font-size:13px;">
                            <div v-for="key in sortedRoomKeys" :key="'res-'+key" 
                                 style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; padding-bottom:4px; border-bottom:1px dashed #eee;">
                                
                                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px;"
                                      :title="rooms[key].name">
                                    {{ rooms[key].name }}
                                </span>
                                
                                <strong style="white-space: nowrap; flex-shrink: 0;">
                                    {{ countAssigned(key) }} äºº
                                </strong>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title">åŒ¯å‡ºçµæœ (HTML)</span></div>
                        <div style="font-size: 13px; color: var(--text-sub); margin-bottom: 20px;"> åŒ¯å‡ºç‚º HTML ç¶²é æª”ï¼Œå¯ç”¨ç€è¦½å™¨é–‹å•Ÿåˆ—å°ã€‚ </div>
                        <button class="quiet-btn btn-outline" style="width:100%; margin-bottom:20px;" @click="downloadHTML('seat')">
                            ğŸ’¾ å¦å­˜ åº§ä½è¡¨ (.html)
                        </button>
                        <div style="background:#f8f9fa; padding:12px; border-radius:8px; border:1px solid #e9ecef; margin-bottom:10px;">
                            <label class="form-label" style="margin-bottom:8px;">ç°½åˆ°è¡¨ç‰ˆé¢è¨­å®šï¼š</label>
                            <div style="display:flex; gap:15px;">
                                <div style="flex:1;">
                                    <label style="font-size:12px; color:#666;">æ¯é æ¬„æ•¸ (Cols)</label>
                                    <input type="number" class="form-control" v-model.number="exportConfig.colsPerPage" min="1" max="4" style="padding:4px 8px;">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:12px; color:#666;">æ¯æ¬„åˆ—æ•¸ (Rows)</label>
                                    <input type="number" class="form-control" v-model.number="exportConfig.rowsPerPage" min="10" max="100" style="padding:4px 8px;">
                                </div>
                            </div>
                            <div style="font-size:11px; color:#999; margin-top:5px;">
                                é è¨­ï¼šæ¯é  2 æ¬„ï¼Œæ¯æ¬„ 25 åˆ—ï¼ˆå…± 50 äºº/é ï¼‰ã€‚
                            </div>
                        </div>
                        <button class="quiet-btn btn-outline" style="width:100%; margin-bottom:10px;" @click="downloadHTML('signin_global')">
                            ğŸ’¾ å¦å­˜ ç¸½ç°½åˆ°è¡¨ (.html)
                        </button>
                        <button class="quiet-btn btn-outline" style="width:100%;" @click="downloadHTML('signin_room')">
                            ğŸ’¾ å¦å­˜ è€ƒå ´ç°½åˆ°è¡¨ (.html)
                        </button>
                    </div>
                </div>

                <!-- å³ï¼šé è¦½å€ -->
                <div style="width:100%; min-width: 0;">
                    <!-- æ•™å®¤åˆ‡æ› Tab -->
                    <div class="room-slides-container">
                        <div v-for="key in sortedRoomKeys" :key="'tab-'+key" 
                            class="room-slide" :class="{active: previewRoomKey === key}"
                            style="flex: 0 0 140px; height: 90px;"
                            @click="previewRoomKey = key">
                            <div class="room-slide-info">
                                <h4 style="font-size:14px;">{{ rooms[key].name }}</h4>
                                <div class="room-slide-stats">
                                    {{ rooms[key].rowSpecs.filter(x=>x).length }} è¡Œ Ã— {{ rooms[key].colSpecs.filter(x=>x).length }} åˆ—
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" v-if="previewRoomKey">
                        <div class="card-header" style="justify-content: flex-start; gap: 12px;">
                            
                            <span class="card-title" style="margin:0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;">
                                è€ƒå ´åº§ä½é è¦½ï¼š{{ rooms[previewRoomKey].name }}
                            </span>
                            
                            <span class="badge badge-info" style="font-size: 12px; align-self: center; flex-shrink: 0;">
                                å·²åˆ†é… {{ countAssigned(previewRoomKey) }} äºº
                            </span>
                        </div>
                        
                        <div class="grid-editor-wrapper" style="border:none; padding:0px 0px 10px 0px; min-height:auto;">
                            <transition name="room-switch" mode="out-in">
                                <div :key="previewRoomKey" style="display: inline-block; min-width: 100%;">
                                    <!-- å…¥å£æ¨™ç¤º (å‰) -->
                                    <div v-if="rooms[previewRoomKey].entrancePos === 'front'" 
                                        style="text-align:right; color:var(--danger); font-size:12px; margin:15px; font-weight:bold;"
                                        :style="{textAlign: rooms[previewRoomKey].entrance === 'left' ? 'left' : 'right'}">
                                        {{ rooms[previewRoomKey].entrance === 'left' ? 'â¬… å…¥å£ä½ç½®ï¼ˆå‰ï¼‰' : 'å…¥å£ä½ç½®ï¼ˆå‰ï¼‰ â®•' }}
                                    </div>
                                    
                                    <div class="grid-layout" :style="getGridStyle(previewRoomKey)">
                                        <div></div>
                                        <div v-for="h in rooms[previewRoomKey].headers" class="col-header" :class="{'aisle-label': h==='èµ°é“'}">{{ h }}</div>
                                        <div></div>

                                        <template v-for="(rLabel, rIdx) in rooms[previewRoomKey].rowHeaders">
                                            <div class="row-header">{{ rLabel }}</div>
                                            <div v-for="(colSpec, cIdx) in rooms[previewRoomKey].colSpecs"
                                                class="seat"
                                                :class="{
                                                    'aisle': colSpec===0 || rooms[previewRoomKey].rowSpecs[rIdx]===0,
                                                    'blocked': getSeat(previewRoomKey, rIdx, cIdx).type===2,
                                                    'student': getSeat(previewRoomKey, rIdx, cIdx).student
                                                }">
                                                <span v-if="getSeat(previewRoomKey, rIdx, cIdx).type===2">âœ•</span>
                                                <div v-if="getSeat(previewRoomKey, rIdx, cIdx).student" style="text-align:center;">
                                                    <div class="s-id">{{ getSeat(previewRoomKey, rIdx, cIdx).student.sID }}</div>
                                                    <div class="s-name">{{ getSeat(previewRoomKey, rIdx, cIdx).student.Name }}</div>
                                                </div>
                                            </div>
                                            <div class="row-header">{{ rLabel }}</div>
                                        </template>
                                    </div>

                                    <!-- å…¥å£æ¨™ç¤º (å¾Œ) -->
                                    <div v-if="rooms[previewRoomKey].entrancePos === 'back'" 
                                        style="text-align:right; color:var(--danger); font-size:12px; margin:15px; font-weight:bold;"
                                        :style="{textAlign: rooms[previewRoomKey].entrance === 'left' ? 'left' : 'right'}">
                                        {{ rooms[previewRoomKey].entrance === 'left' ? 'â¬… å…¥å£ä½ç½®ï¼ˆå¾Œï¼‰' : 'å…¥å£ä½ç½®ï¼ˆå¾Œï¼‰ â®•' }}
                                    </div>
                                </div>
                            </transition>
                        </div>
                        <div class="notice" style="margin: 20px 0px 0px 0px;">
                            é è¦½å…§å®¹èˆ‡åŒ¯å‡ºçš„ HTML ç¶²é æª”ç›¸åŒã€‚
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- åº•éƒ¨å°èˆª -->
        <div class="action-bar">

            <button v-if="step === 2" class="btn btn-outline" @click="step--">â¬… ä¸Šä¸€æ­¥ï¼ˆè³‡æ–™æº–å‚™ï¼‰</button>
            <button v-else-if="step === 3" class="btn btn-outline" @click="step--">â¬… ä¸Šä¸€æ­¥ï¼ˆå ´åœ°ä½ˆå±€ï¼‰</button>
            <button v-else-if="step === 4" class="btn btn-outline" @click="step--">â¬… ä¸Šä¸€æ­¥ï¼ˆåˆ†é…è¦å‰‡ï¼‰</button>
            <div v-else></div> 
            
            <button v-if="step === 1" class="btn btn-primary" @click="goNext">ä¸‹ä¸€æ­¥ï¼ˆå ´åœ°ä½ˆå±€ï¼‰ â®•</button>
            <button v-if="step === 2" class="btn btn-primary" @click="goNext">ä¸‹ä¸€æ­¥ï¼ˆåˆ†é…è¦å‰‡ï¼‰ â®•</button>
            <button v-if="step === 3" class="btn btn-primary" @click="runAssignment">ä¸‹ä¸€æ­¥ï¼ˆé è¦½èˆ‡åŒ¯å‡ºï¼‰ â®•</button>

            <div v-if="step === 4" style="display:flex; gap:20px;">
                 <button class="btn btn-primary" @click="runAssignment">
                    â†» é‡æ–°åŸ·è¡Œåˆ†é…ï¼ˆæ´—ç‰Œï¼‰
                </button>
                <button class="btn btn-outline-danger" @click="step=1; students=[]; rooms={}; initRooms();">
                    âš  é‡æ–°é–‹å§‹ï¼ˆæ¸…ç©ºè³‡æ–™ï¼‰
                </button>
            </div>
        </div>
    </div><!-- End of main-card -->

    <!-- Footer outside main-card -->
    <div class="footer">
        <div style="display: inline-flex; align-items: center;">
            Â© 2025 è€ƒå ´åº§ä½éš¨æ©Ÿåˆ†é…ç³»çµ± Release 1.3
            <!-- <span class="badge" style="margin-left: 4px; padding: 1px 4px; font-size: 8px; border: 1px solid #6c757d;">BETA</span> -->
        </div>
        <div style="margin-top: 5px;">Alpha Lab | 
            <a href="mailto:harper.17555@gmail.com">å•é¡Œå›å ±</a>
        </div>
    </div>
</div><!-- End of app -->

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            step: 1,
            isDragActive: false,
            errorMessage: '',
            isReloading: false,
            
            // è€ƒè©¦è³‡æ–™
            examInfo: { semester: '', title: '', date: '', startTime: '', endTime: '', note: '' },
            students: [],
            
            // æ•™å®¤è³‡æ–™
            rooms: {},
            roomQuotas: {}, // æ‰‹å‹•é…é¡
            currentRoomKey: null, // ç·¨è¼¯ä¸­
            previewRoomKey: null,    // é è¦½ä¸­
            customRoomCount: 0,
            isLayoutAnimating: false,
            animTarget: { key: null, type: null, index: -1, action: null },
            roomSequence: 4,
            
            // åˆ†é…è¨­å®š
            assignConfig: { distribute: 'auto', seat: 'random' },
            fillPrefs: { priority: 'row', rowDir: 'forward', colDir: 'left_right' },
            
            // å‹•ç•«è®Šæ•¸
            animStep: 0,
            animTimer: null,
            
            exportType: 'none',

            manualInput: { sID: '', Name: '' },
            manualMsg: '',
            manualMsgType: '',
            sortType: 'import', // import, asc, desc, manual
            importCounter: 1,   // ç”¨ä¾†è¨˜éŒ„åŒ¯å…¥é †åº

            // åŒ¯å‡ºè¨­å®š (é è¨­å€¼ï¼šæ¯é  2 æ¬„ï¼Œæ¯æ¬„ 25 åˆ—)
            exportConfig: {
                colsPerPage: 2,
                rowsPerPage: 25
            },
            }
    },
    computed: {
        totalAvailable() {
            return Object.values(this.rooms)
                .filter(r => r.selected)
                .reduce((acc, r) => acc + (r.seats ? r.seats.filter(s => s.type === 1).length : 0), 0);
        },
        sortedRoomKeys() {
            return Object.keys(this.rooms)
                .filter(k => this.rooms[k].selected)
                .sort((a,b) => this.rooms[a].order - this.rooms[b].order);
        },
        lastActiveRoomKey() {
            const keys = this.sortedRoomKeys;
            return keys.length > 0 ? keys[keys.length-1] : null;
        },
        autoAllocatedCount() {
            // è¨ˆç®—æœ€å¾Œä¸€é–“æ•™å®¤éœ€è¦å®¹ç´å¤šå°‘äºº
            let assigned = 0;
            const last = this.lastActiveRoomKey;
            this.sortedRoomKeys.forEach(k => {
                if(k !== last) assigned += (this.roomQuotas[k] || 0);
            });
            return Math.max(0, this.students.length - assigned);
        },
        isOverloaded() {
            if(!this.lastActiveRoomKey) return false;
            // éš¨æ©Ÿåˆ†é…æ¨¡å¼ä¸‹ï¼Œæ²’æœ‰æ‰‹å‹•é…é¡ï¼Œåªçœ‹ç¸½æ•¸
            if(this.assignConfig.distribute === 'auto') {
                return this.students.length > this.totalAvailable;
            }
            return this.autoAllocatedCount > this.getRoomAvailable(this.lastActiveRoomKey);
        },
        totalAssigned() {
            let count = 0;
            Object.values(this.rooms).forEach(r => {
                if(r.seats) count += r.seats.filter(s => s.student).length;
            });
            return count;
        },
        globalSigninList() {
             let list = [];
             this.sortedRoomKeys.forEach(k => {
                 this.rooms[k].seats.forEach(s => {
                     if(s.student) list.push(s.student);
                 });
             });
             // ç°½åˆ°è¡¨ä¾å­¸è™Ÿæ’åº
             return list.sort((a,b) => a.sID.localeCompare(b.sID));
        },
        duplicateCount() {
            return this.students.filter(s => s.isDuplicate).length;
        }
    },
    watch: {
        // ç•¶è¨­å®šæ”¹è®Šæ™‚ï¼Œé‡å•Ÿå‹•ç•«
        fillPrefs: {
            handler() { this.startAnimation(); },
            deep: true
        },
        step(val) {
            // 1. æ–°å¢ï¼šåˆ‡æ›æ­¥é©Ÿæ™‚ï¼Œå¼·åˆ¶è¦–çª—æ²å‹•å›æœ€ä¸Šæ–¹
            window.scrollTo(0, 0);

            // 2. åŸæœ‰çš„å‹•ç•«æ§åˆ¶é‚è¼¯ (é€²å…¥ Step 3 å•Ÿå‹•å‹•ç•«ï¼Œé›¢é–‹å‰‡åœæ­¢)
            if(val === 3) this.startAnimation();
            else this.stopAnimation();
        },
        // ç›£è½åˆ†æµç­–ç•¥ï¼Œåˆ‡æ›åˆ°æ‰‹å‹•æ¨¡å¼æ™‚ï¼Œå°‡é…é¡é è¨­ç‚º 0
        'assignConfig.distribute'(val) {
            if (val === 'sequential') {
                this.sortedRoomKeys.forEach(key => {
                    // å¦‚æœåŸæœ¬æ²’æœ‰å€¼ï¼Œæˆ–æ˜¯åˆ‡æ›æ¨¡å¼æ™‚å¸Œæœ›æ­¸é›¶ï¼Œå¯åœ¨æ­¤è¨­å®š
                    // é€™è£¡è¨­å®šç‚º 0ï¼Œè®“ä½¿ç”¨è€…é‡æ–°è¼¸å…¥
                    this.roomQuotas[key] = 0; 
                });
            }
        }
    },
    methods: {
        // --- Animation Control ---
        startAnimation() {
            this.stopAnimation();
            this.animStep = 0;
            this.animTimer = setInterval(() => {
                this.animStep++;
                if(this.animStep > 25) this.animStep = 0; // Loop with a pause
            }, 120); // å‹•ç•«é€Ÿåº¦ 120ms
        },
        stopAnimation() {
            if(this.animTimer) clearInterval(this.animTimer);
        },
        getAnimOrder(n) {
            const r = Math.floor(n / 5);
            const c = n % 5;
            let rVal = r, cVal = c;
            if(this.fillPrefs.rowDir === 'backward') rVal = 4 - r;
            if(this.fillPrefs.colDir === 'right_left') cVal = 4 - c;
            
            if(this.fillPrefs.priority === 'row') {
                return rVal * 5 + cVal;
            } else {
                return cVal * 5 + rVal;
            }
        },

        // --- Step 1: æª”æ¡ˆèˆ‡è³‡è¨Šè™•ç† ---
        getFullTime() {
             let str = this.examInfo.date;
             if(this.examInfo.startTime) str += ` ${this.examInfo.startTime}`;
             if(this.examInfo.endTime) str += ` - ${this.examInfo.endTime}`;
             return str;
        },
        
        handleFileSelect(e) { 
            Array.from(e.target.files).forEach(f => this.parseFile(f));
            e.target.value = ''; // Reset to allow same file re-upload
        },
        handleDrop(e) { 
            this.isDragActive=false; 
            Array.from(e.dataTransfer.files).forEach(f => this.parseFile(f));
        },
        parseFile(file) {
            const name = file.name.toLowerCase();
            if(name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: false, skipEmptyLines: true,
                    complete: (res) => this.processData(res.data)
                });
            } else if(name.endsWith('.xlsx') || name.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    this.processData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else {
                this.errorMessage = 'åƒ…æ”¯æ´ .csv æˆ– .xlsx æ ¼å¼';
            }
        },
        processData(rows) {
            let newStudents = [];
            
            // ç”¨ä¾†åˆ¤æ–·æ˜¯å¦ç‚ºæ¨™é¡Œåˆ—çš„é—œéµå­—
            const headerKeywords = ['å­¸è™Ÿ', 'id', 'ID', 'sid', 'å§“å', 'name', 'Name', 'NAME'];

            rows.forEach(row => {
                if(row.length >= 2) {
                    const sID = String(row[0]).trim();
                    const sName = String(row[1]).trim();
                    
                    // 1. åŸºæœ¬æª¢æŸ¥ï¼šå­¸è™Ÿä¸èƒ½ç‚ºç©º
                    if (!sID) return;

                    // 2. éæ¿¾æ¨™é¡Œåˆ—ï¼š
                    // å¦‚æœå­¸è™Ÿæ¬„ä½åŒ…å« "å­¸è™Ÿ/ID" ç­‰å­—çœ¼ï¼Œæˆ–è€…å­¸è™Ÿå¤ªçŸ­ä¸”ä¸æ˜¯è‹±æ•¸çµ„åˆï¼Œé€šå¸¸æ˜¯æ¨™é¡Œ
                    const isHeader = headerKeywords.some(k => sID.toLowerCase().includes(k));
                    // å¦‚æœæ˜¯æ¨™é¡Œåˆ—ï¼Œè·³é
                    if (isHeader) return;

                    // 3. å»ºç«‹è€ƒç”Ÿç‰©ä»¶ (åŠ å…¥ _oid ä»¥æ”¯æ´ã€ŒåŒ¯å…¥é †åºã€æ’åº)
                    newStudents.push({ 
                        sID: sID, 
                        Name: sName, 
                        isDuplicate: false,
                        _oid: this.importCounter++ 
                    });
                }
            });

            // 4. åµæ¸¬æœ¬æ¬¡åŒ¯å…¥çš„é‡è¤‡é …ç›® (ä¸¦è·³å‡º Alert)
            const seen = new Set();
            // å…ˆè¼‰å…¥èˆŠåå–®çš„å­¸è™Ÿ
            this.students.forEach(s => seen.add(s.sID.toLowerCase()));
            
            let dupCountThisBatch = 0;
            newStudents.forEach(s => {
                const lowID = s.sID.toLowerCase();
                if(seen.has(lowID)) {
                    s.isDuplicate = true;
                    dupCountThisBatch++;
                } else {
                    seen.add(lowID);
                }
            });

            if(dupCountThisBatch > 0) {
                alert(`âš ï¸ åµæ¸¬åˆ° ${dupCountThisBatch} ç­†é‡è¤‡çš„å­¸è™Ÿï¼`);
            }

            // åˆä½µåå–®
            this.students = [...this.students, ...newStudents];
            
            // é‡æ–°å…¨åŸŸæƒæé‡è¤‡ (ç¢ºä¿æ–°èˆŠè³‡æ–™æ··åˆå¾Œçš„é‡è¤‡ç‹€æ…‹æ­£ç¢º)
            this.markAllDuplicates();
            
            // ç¶­æŒç›®å‰çš„æ’åºè¨­å®š
            this.sortStudents(this.sortType); 
            this.errorMessage = '';
        },
        onStudentUpdate() {
            // 1. ç·¨è¼¯å¾Œç«‹å³é‡æ–°æª¢æŸ¥é‡è¤‡
            this.markAllDuplicates();
            
            // 2. å¦‚æœå¸Œæœ›ç·¨è¼¯å­¸è™Ÿå¾Œè‡ªå‹•é‡æ–°æ’åº (ä¾‹å¦‚åŸæœ¬æ˜¯ A-Z)ï¼Œå¯ä»¥æŠŠä¸‹é¢é€™è¡Œæ‰“é–‹
            // ä½†é€šå¸¸ç·¨è¼¯ä¸­ä¸å¸Œæœ›è¡Œçªç„¶è·³èµ°ï¼Œæ‰€ä»¥å»ºè­°å…ˆä¸è‡ªå‹•æ’åºï¼Œç­‰ä½¿ç”¨è€…è‡ªå·±æŒ‰æ’åºæŒ‰éˆ•
            // this.sortStudents(this.sortType); 
        },
        markAllDuplicates() {
            const counts = {};
            this.students.forEach(s => {
                const k = s.sID.toLowerCase();
                counts[k] = (counts[k] || 0) + 1;
            });
            this.students.forEach(s => {
                // åªè¦å‡ºç¾è¶…éä¸€æ¬¡ï¼Œå°±æ¨™è¨˜ç‚ºé‡è¤‡
                s.isDuplicate = (counts[s.sID.toLowerCase()] > 1);
            });
        },
        addManualStudent() {
            const id = this.manualInput.sID.trim();
            const name = this.manualInput.Name.trim();
            
            if(!id || !name) {
                alert('è«‹è¼¸å…¥å®Œæ•´å­¸è™Ÿèˆ‡å§“å'); // æ”¹ç”¨ alert
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if(this.students.some(s => s.sID.toLowerCase() === id.toLowerCase())) {
                alert('æ­¤å­¸è™Ÿå·²å­˜åœ¨åå–®ä¸­ï¼'); // æ”¹ç”¨ alert
                return; 
            }

            this.students.push({
                sID: id,
                Name: name,
                isDuplicate: false,
                _oid: this.importCounter++ 
            });
            
            // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦æç¤ºæˆåŠŸ
            this.manualInput.sID = '';
            this.manualInput.Name = '';
            
            this.markAllDuplicates();
            this.sortStudents(this.sortType);
            
            alert('æ–°å¢æˆåŠŸï¼');
        },
        sortStudents(type) {
            this.sortType = type;
            if (type === 'manual') return; // æ‰‹å‹•æ¨¡å¼ä¸è‡ªå‹•æ’

            if (type === 'asc') {
                this.students.sort((a,b) => a.sID.localeCompare(b.sID));
            } else if (type === 'desc') {
                this.students.sort((a,b) => b.sID.localeCompare(a.sID));
            } else if (type === 'import') {
                this.students.sort((a,b) => a._oid - b._oid);
            }
        },
        // æ‰‹å‹•ç§»å‹• (ä¸Š/ä¸‹)
        moveStudent(index, dir) {
            if (this.sortType !== 'manual') return;
            const target = index + dir;
            if (target < 0 || target >= this.students.length) return;
            
            // Swap
            const temp = this.students[index];
            this.students[index] = this.students[target];
            this.students[target] = temp;
        },
        // HTML åŒ¯å‡ºåŠŸèƒ½
        downloadHTML(type) {
            let suffix = '';
            if (type === 'seat') suffix = 'åº§ä½è¡¨';
            else if (type === 'signin_global') suffix = 'ç¸½ç°½åˆ°è¡¨';
            else if (type === 'signin_room') suffix = 'è€ƒå ´ç°½åˆ°è¡¨';

            const contentHeader = `${this.examInfo.semester} ${this.examInfo.title}`;
            const displayTitle = `${contentHeader} ${suffix}`;
            const safeFilename = `${this.examInfo.semester}_${this.examInfo.title}_${suffix}`;
            const timeStr = this.getFullTime();
            
            let content = '';
            
            const style = `
                <style>
                    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; }
                    h1, h2, h3 { text-align: center; margin: 5px 0; }
                    .page-break { page-break-after: always; display: block; clear: both; margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 20px;}
                    
                    /* ç¶²æ ¼å®¹å™¨ */
                    .grid-container { 
                        display: flex; 
                        flex-direction: column; 
                        align-items: center; 
                        margin-top: 20px; 
                    }
                    
                    /* ç¶²æ ¼åŒ…è£å™¨ï¼šè¨­ç‚º inline-flex è®“å¯¬åº¦è²¼é½Šç¶²æ ¼ï¼Œä»¥ä¾¿çµ•å°å®šä½ç®­é ­ */
                    .grid-wrapper { 
                        display: inline-flex; 
                        flex-direction: column; 
                        width: auto;
                        position: relative;
                    }
                    
                    /* å…¥å£åˆ—ä½”ä½å®¹å™¨ */
                    .entrance-row {
                        height: 24px; 
                        width: 100%;
                        position: relative;
                        margin: 20px 0px 20px 0px;
                    }
                    .entrance-row.bottom {
                    }

                    /* å…¥å£æ¨™è¨˜æœ¬é«” */
                    .entrance-marker {
                        position: absolute;
                        font-weight: bold;
                        color: #dc3545;
                        font-size: 12px;
                        white-space: nowrap;
                        line-height: 24px;
                    }
                    
                    .grid { display: grid; gap: 4px; justify-content: center; } 
                    .seat { 
                        border: 1px solid #333; display: flex; flex-direction: column; 
                        align-items: center; justify-content: center; padding: 2px;
                        width: 60px; height: 40px; font-size: 12px; background: #fff;
                    }
                    .seat.aisle { border: none; visibility: hidden; }
                    .seat .sid { font-weight: bold; font-size: 12px; }
                    .seat .name { font-size: 11px; white-space: nowrap; overflow: hidden; }
                    .header-cell { text-align: center; font-weight: bold; font-size: 11px; padding: 2px; color: #666; }
                    .header-cell.aisle-label { color: #ccc; }
                    
                    table.signin { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
                    table.signin th, table.signin td { border: 1px solid #000; padding: 5px; text-align: center; height: 30px; }
                    table.signin th { background: #f0f0f0; }
                    .flex-row { display: flex; gap: 20px; justify-content: center; }
                    .flex-col { flex: 1; }
                    @media print {
                        .page-break { border-bottom: none; height: 0; margin: 0; }
                        body { padding: 0; }
                    }
                </style>
            `;

            if (type === 'seat') {
                this.sortedRoomKeys.forEach(key => {
                    const room = this.rooms[key];
                    const count = this.countAssigned(key);
                    
                    // Grid Style
                    let gridTemplateColumns = `30px `; 
                    room.colSpecs.forEach(c => gridTemplateColumns += c === 1 ? '60px ' : '20px ');
                    gridTemplateColumns += '30px';
                    let gridTemplateRows = `auto `; 
                    room.rowSpecs.forEach(r => gridTemplateRows += r === 1 ? '40px ' : '20px ');
                    const gridStyle = `grid-template-columns: ${gridTemplateColumns}; grid-template-rows: ${gridTemplateRows};`;

                    // [ä¿®æ”¹] ç”Ÿæˆå…¥å£ HTML (æ•´åˆæ–‡å­—èˆ‡æ–¹å‘)
                    const isLeft = room.entrance === 'left';
                    const posText = room.entrancePos === 'front' ? '(å‰)' : '(å¾Œ)';
                    const labelText = `å…¥å£ä½ç½® ${posText}`; // å®Œæ•´æ–‡å­—
                    
                    // æ ¹æ“šå·¦å³æ±ºå®šæ¨£å¼ï¼šå·¦å´é å·¦ï¼Œå³å´é å³
                    const posStyle = isLeft ? 'left: 0; padding-left:10px;' : 'right: 0; padding-right:10px;';
                    
                    // æ ¹æ“šå·¦å³æ±ºå®šç®­é ­ä½ç½®ï¼šå·¦å´ç®­é ­åœ¨å­—å‰ï¼Œå³å´ç®­é ­åœ¨å­—å¾Œ
                    // å·¦ï¼šâ¬… å…¥å£ä½ç½® (å‰)
                    // å³ï¼šå…¥å£ä½ç½® (å‰) â®•
                    const contentHTML = isLeft ? `â¬… ${labelText}` : `${labelText} â®•`;
                    
                    let topRowHTML = `<div class="entrance-row"></div>`; 
                    let bottomRowHTML = `<div class="entrance-row bottom"></div>`; 

                    if (room.entrancePos === 'front') {
                        topRowHTML = `
                            <div class="entrance-row">
                                <div class="entrance-marker" style="${posStyle}">
                                    ${contentHTML}
                                </div>
                            </div>`;
                    } else {
                        bottomRowHTML = `
                            <div class="entrance-row bottom">
                                <div class="entrance-marker" style="${posStyle}">
                                    ${contentHTML}
                                </div>
                            </div>`;
                    }

                    // ç”Ÿæˆåº§ä½ HTML
                    let cells = '<div></div>'; 
                    room.headers.forEach(h => {
                        const extraClass = h === 'èµ°é“' ? ' aisle-label' : '';
                        cells += `<div class="header-cell${extraClass}">${h}</div>`;
                    });
                    cells += '<div></div>'; 

                    room.rowHeaders.forEach((rLabel, rIdx) => {
                        const rClass = rLabel === 'èµ°é“' ? ' aisle-label' : '';
                        cells += `<div class="header-cell${rClass}">${rLabel}</div>`;
                        room.colSpecs.forEach((colSpec, cIdx) => {
                            const seat = this.getSeat(key, rIdx, cIdx);
                            if (colSpec === 0 || room.rowSpecs[rIdx] === 0) cells += `<div class="seat aisle"></div>`;
                            else if (seat.type === 2) cells += `<div class="seat" style="background:#eee; color:#ccc;">âœ•</div>`;
                            else {
                                if (seat.student) cells += `<div class="seat"><div class="sid">${seat.student.sID}</div><div class="name">${seat.student.Name}</div></div>`;
                                else cells += `<div class="seat"><div style="color:#ccc; font-size:9px;">${seat.coordStr}</div></div>`;
                            }
                        })
                        cells += `<div class="header-cell${rClass}">${rLabel}</div>`;
                    });

                    content += `
                        <div class="page-break">
                            <h2>${contentHeader}</h2>
                            <h3>ã€${room.name}ã€‘åº§ä½è¡¨</h3>
                            
                            <div style="text-align:center; font-size: 14px; margin-bottom: 10px;">
                                <span>è€ƒå ´äººæ•¸ï¼š${count} äºº</span>
                                ${timeStr ? `<span style="margin-left: 30px;">è€ƒè©¦æ™‚é–“ï¼š${timeStr}</span>` : ''}
                            </div>

                            <div class="grid-container">
                                <div class="grid-wrapper">
                                    ${topRowHTML}
                                    <div class="grid" style="${gridStyle}">
                                        ${cells}
                                    </div>
                                    ${bottomRowHTML}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                // (ç°½åˆ°è¡¨åŒ¯å‡ºé‚è¼¯ä¿æŒä¸è®Š)
                const generateSigninPage = (list, subtitle) => {
                    const pages = this.getPagedList(list);
                    const totalPages = pages.length;

                    let html = '';
                    
                    // è¨ˆç®—æ¯æ¬„å¯¬åº¦ç™¾åˆ†æ¯”ï¼Œæ¸›å»ä¸€é»é–“éš™ (gap) é¿å…æ“ ä¸‹å»
                    const colWidth = (100 / this.exportConfig.colsPerPage) - 1;

                    pages.forEach(p => {
                        // ç”¢ç”Ÿæ¯ä¸€æ¬„çš„ HTML
                        let columnsHTML = '';
                        p.columns.forEach((colData, colIndex) => {
                            let rows = '';
                            // è¨ˆç®—è©²æ¬„ç¬¬ä¸€ç­†è³‡æ–™çš„èµ·å§‹åº§è™Ÿ
                            // å…¬å¼ï¼š(é ç¢¼-1)*æ¯é ç¸½æ•¸ + (æ¬„ç¢¼)*æ¯æ¬„åˆ—æ•¸ + 1
                            const startNo = (p.pageIndex - 1) * (this.exportConfig.rowsPerPage * this.exportConfig.colsPerPage) + (colIndex * this.exportConfig.rowsPerPage) + 1;

                            colData.forEach((s, i) => {
                                if (!s.empty) {
                                    rows += `<tr><td>${startNo + i}</td><td>${s.sID}</td><td>${s.Name}</td><td></td></tr>`;
                                } else {
                                    rows += `<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>`;
                                }
                            });
                            
                            columnsHTML += `
                                <div class="flex-col" style="flex: 0 0 ${colWidth}%; max-width: ${colWidth}%;">
                                    <table class="signin">
                                        <thead><tr><th width="12%">No.</th><th width="25%">å­¸è™Ÿ</th><th width="25%">å§“å</th><th width="38%">ç°½å</th></tr></thead>
                                        <tbody>${rows}</tbody>
                                    </table>
                                </div>
                            `;
                        });

                        html += `
                            <div class="page-break">
                                <h2>${contentHeader}</h2>
                                <h3>${subtitle}ï¼ˆç¬¬ ${p.pageIndex} é  / å…± ${totalPages} é ï¼‰</h3>
                                ${timeStr ? `<p style="text-align:center;margin:0 0 10px 0;font-size:12px;">è€ƒè©¦æ™‚é–“ï¼š${timeStr}</p>` : ''}
                                <div class="flex-row" style="gap: 2%;">
                                    ${columnsHTML}
                                </div>
                            </div>
                        `;
                    });
                    return html;
                };
                if (type === 'signin_global') content = generateSigninPage(this.students, 'ç¸½ç°½åˆ°è¡¨');
                else {
                    this.sortedRoomKeys.forEach(key => {
                        const list = this.getRoomAssignedList(key);
                        if (list.length > 0) content += generateSigninPage(list, `${this.rooms[key].name} ç°½åˆ°è¡¨`);
                    });
                }
            }

            const fullHTML = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${displayTitle}</title>${style}</head><body>${content}</body></html>`;
            const blob = new Blob([fullHTML], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${safeFilename}.html`; 
            link.click();
        },
        removeDuplicates() {
            if(!confirm(`ç¢ºå®šè¦ç§»é™¤æ‰€æœ‰é‡è¤‡çš„è€ƒç”Ÿè³‡æ–™å—ï¼Ÿ\n(å°‡ä¿ç•™ç¬¬ä¸€ç­†ï¼Œåˆªé™¤å¾ŒçºŒé‡è¤‡é …ç›®)`)) return;
            
            const seen = new Set();
            const unique = [];
            
            // é€™è£¡å»ºè­°å…ˆä¾ç…§ã€ŒåŒ¯å…¥é †åºã€æˆ–ã€Œå­¸è™Ÿã€ç©©å®šæ’åºå¾Œå†éæ¿¾ï¼Œ
            // é¿å…å› ç‚ºç•¶å‰é¡¯ç¤ºæ’åºä¸åŒè€ŒåˆªéŒ¯äººã€‚
            // é€™è£¡æš«æ™‚ä¾ç…§ç•¶å‰åˆ—è¡¨é †åºä¿ç•™ç¬¬ä¸€ç­†ã€‚
            this.students.forEach(s => {
                const k = s.sID.toLowerCase();
                if(!seen.has(k)) {
                    seen.add(k);
                    s.isDuplicate = false; // æ¸…é™¤æ¨™è¨˜
                    unique.push(s);
                }
            });
            
            this.students = unique;
            alert('å·²ç§»é™¤é‡è¤‡è³‡æ–™ï¼');
        },
        removeStudent(idx) {
            const s = this.students[idx];
            // è·³å‡ºç¢ºèªè¦–çª—ï¼Œè‹¥æŒ‰ã€Œå–æ¶ˆã€å‰‡ return ä¸­æ–·åŸ·è¡Œ
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤è€ƒç”Ÿã€Œ${s.sID} ${s.Name}ã€å—ï¼Ÿ`)) return;
            
            this.students.splice(idx, 1);
            this.markAllDuplicates();
        },
        clearStudents() {
            if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åå–®å—ï¼Ÿ')) this.students = [];
        },

        // --- Step 2: æ•™å®¤ç®¡ç†é‚è¼¯ ---
        initRooms() {
            // é è¨­æ•™å®¤é…ç½®
            this.rooms = {};
            
            // Room 1 (é›»è…¦æ•™å®¤ 1): 14 cols (4-1-4-1-4), 6 rows
            this.rooms['room1'] = {
                selected: false, order: 1, name: 'é›»è…¦æ•™å®¤ 1',
                rowSpecs: Array(6).fill(1),
                colSpecs: [1,1,1,1, 0, 1,1,1,1, 0, 1,1,1,1],
                seats: [], headers: [], rowHeaders: [],
                entrance: 'right', entrancePos: 'front', numberingType: 'normal'
            };

            // Room 2 (é›»è…¦æ•™å®¤ 2): 14 cols (4-1-4-1-4), 6 rows
            this.rooms['room2'] = {
                selected: false, order: 2, name: 'é›»è…¦æ•™å®¤ 2',
                rowSpecs: Array(6).fill(1),
                colSpecs: [1,1,1,1, 0, 1,1,1,1, 0, 1,1,1,1],
                seats: [], headers: [], rowHeaders: [],
                entrance: 'right', entrancePos: 'front', numberingType: 'normal'
            };

            // Room 3 (ç ”è¨æ•™å®¤ 6): 
            let colSpecs3 = [];
            for(let i=0; i<15; i++) colSpecs3.push(i % 2 === 0 ? 1 : 0);
            
            this.rooms['room3'] = {
                selected: false, order: 3, name: 'ç ”è¨æ•™å®¤ 6',
                rowSpecs: Array(8).fill(1),
                colSpecs: colSpecs3,
                seats: [], headers: [], rowHeaders: [],
                entrance: 'right', entrancePos: 'front', numberingType: 'normal'
            };

            // åˆå§‹åŒ–ä½ˆå±€
            ['room1', 'room2', 'room3'].forEach(k => {
                this.regenerateRoom(k);
                
                // ç‰¹æ®Šè¦å‰‡ï¼šé›»è…¦æ•™å®¤1 & é›»è…¦æ•™å®¤2 çš„ç¬¬6æ’å‰4å€‹åº§ä½ (1-6, 2-6, 3-6, 4-6) é è¨­ç‚ºç¦ç”¨
                if (k === 'room1' || k === 'room2') {
                    // ç¬¬6æ’ç´¢å¼•ç‚º 5
                    const rIdx = 5;
                    // å‰4å€‹åº§ä½ç´¢å¼•ç‚º 0, 1, 2, 3 (colSpecs ç‚º 1 çš„ä½ç½®)
                    // ç”±æ–¼ colSpecs å‰4å€‹éƒ½æ˜¯1ï¼Œæ‰€ä»¥ cIdx ä¹Ÿæ˜¯ 0,1,2,3
                    [0, 1, 2, 3].forEach(cIdx => {
                        const s = this.getSeat(k, rIdx, cIdx);
                        if (s) s.type = 2; // 2 = blocked
                    });
                }
            });
            this.currentRoomKey = 'room1';

            // é‡ç½®è¨ˆæ•¸å™¨ (å› ç‚ºé è¨­æœ‰ 3 é–“ï¼Œä¸‹ä¸€å€‹ç·¨è™Ÿå¾ 4 é–‹å§‹)
            this.roomSequence = 4;
        },
        
        createRoomObj(order, name, r, c) {
            return {
                selected: true, order, name,
                rowSpecs: Array(r).fill(1), colSpecs: Array(c).fill(1),
                seats: [], headers: [], rowHeaders: [],
                entrance: 'right', entrancePos: 'front', numberingType: 'normal'
            };
        },
        addCustomRoom() {
            // ä½¿ç”¨è¨ˆæ•¸å™¨ç”¢ç”Ÿå”¯ä¸€é †åºè™Ÿ
            const order = this.roomSequence++; 
            
            // ä½¿ç”¨éš¨æ©Ÿå­—ä¸²ç•¶ä½œ key é¿å… key é‡è¤‡ (é›–ç„¶æ©Ÿç‡æ¥µä½ï¼Œä½†æ¯”è¼ƒä¿éšª)
            const key = `custom_${Date.now()}`;
            
            this.rooms[key] = {
                selected: true, 
                order: order, // ä½¿ç”¨å”¯ä¸€ç·¨è™Ÿ
                name: `è‡ªè¨‚è€ƒå ´ ${order}`,
                rowSpecs: Array(6).fill(1), 
                colSpecs: Array(8).fill(1),
                seats: [], headers: [], rowHeaders: [],
                entrance: 'right', entrancePos: 'front', numberingType: 'normal'
            };
            this.regenerateRoom(key);
            this.currentRoomKey = key; // è‡ªå‹•åˆ‡æ›åˆ°æ–°è€ƒå ´
            
            // æ²å‹•åˆ°æœ€å³é‚Š
            this.$nextTick(() => {
                const container = document.querySelector('.room-slides-container');
                if(container) container.scrollLeft = container.scrollWidth;
            });
        },
        removeRoom(key) {
            if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${this.rooms[key].name}ã€å—ï¼Ÿ`)) {
                delete this.rooms[key];
                delete this.roomQuotas[key];
                const keys = Object.keys(this.rooms);
                this.currentRoomKey = keys.length > 0 ? keys[0] : null;
            }
        },
        moveOrder(key, direction) {
            const keys = this.sortedRoomKeys;
            const idx = keys.indexOf(key);
            if (idx === -1) return;
            const targetIdx = idx + direction;
            if (targetIdx < 0 || targetIdx >= keys.length) return;
            
            const otherKey = keys[targetIdx];
            // Swap order
            const temp = this.rooms[key].order;
            this.rooms[key].order = this.rooms[otherKey].order;
            this.rooms[otherKey].order = temp;
        },

        // --- ä½ˆå±€ç”Ÿæˆé‚è¼¯ ---
        regenerateRoom(key, preserve = false, shiftRow = 0, shiftCol = 0) {
            const room = this.rooms[key];
            
            // 1. è¨˜éŒ„è¢«åœç”¨çš„åº§ä½ (Blocked Seats)
            // å°‡èˆŠåº§æ¨™åŠ ä¸Šåç§»é‡ï¼Œæ˜ å°„åˆ°æ–°åº§æ¨™
            const blocked = new Set();
            if(preserve && room.seats) {
                room.seats.forEach(s => {
                    if(s.type === 2) {
                        blocked.add(`${s.rIdx + shiftRow},${s.cIdx + shiftCol}`);
                    }
                });
            }

            const seats = [];
            const headers = [];
            const rowHeaders = [];
            
            // 2. ç”Ÿæˆè¡Œæ¨™é¡Œ (Headers)
            let seatColCount = 0;
            const totalSeatCols = room.colSpecs.filter(x => x===1).length;
            const isLtoR = room.numberingType === 'normal';

            room.colSpecs.forEach(spec => {
                if(spec === 0) headers.push('èµ°é“');
                else {
                    seatColCount++;
                    headers.push(isLtoR ? seatColCount : (totalSeatCols - seatColCount + 1));
                }
            });
            room.headers = headers;

            // 3. ç”Ÿæˆåˆ—æ¨™é¡Œ (Row Headers)
            let seatRowCount = 0;
            room.rowSpecs.forEach(spec => {
                if(spec === 0) rowHeaders.push('èµ°é“');
                else {
                    seatRowCount++;
                    rowHeaders.push(seatRowCount);
                }
            });
            room.rowHeaders = rowHeaders;

            // 4. ç”Ÿæˆåº§ä½çŸ©é™£
            let logicalRow = 0;
            for(let r=0; r < room.rowSpecs.length; r++) {
                if(room.rowSpecs[r]===1) logicalRow++;
                let logicalCol = 0;
                
                for(let c=0; c < room.colSpecs.length; c++) {
                    // é è¨­å‹æ…‹ï¼šå¦‚æœæ˜¯è¡Œåˆ—è¦æ ¼è¨­ç‚º0ï¼Œå°±æ˜¯èµ°é“(0)ï¼Œå¦å‰‡ç‚ºåº§ä½(1)
                    let type = (room.rowSpecs[r]===0 || room.colSpecs[c]===0) ? 0 : 1;
                    
                    // å¦‚æœåŸæœ¬æ˜¯åº§ä½(1)ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨ blocked æ¸…å–®ä¸­ï¼Œæ˜¯å‰‡æ”¹ç‚ºåœç”¨(2)
                    if(preserve && type===1 && blocked.has(`${r},${c}`)) type = 2;

                    let coordStr = '';
                    if(room.colSpecs[c]===1) {
                        logicalCol++;
                        if(type !== 0) {
                            let displayCol = isLtoR ? logicalCol : (totalSeatCols - logicalCol + 1);
                            coordStr = `${displayCol}-${logicalRow}`;
                        }
                    }

                    seats.push({ rIdx: r, cIdx: c, type, coordStr, student: null });
                }
            }
            room.seats = seats;
        },

        // --- ä½ˆå±€ç·¨è¼¯æ“ä½œ ---
        // è¼”åŠ©å‡½å¼ï¼šå–å¾—è©²æ ¼å­æ‡‰ç”¨çš„å‹•ç•« Class
        getAnimClass(key, type, idx) {
            const t = this.animTarget;
            if (t.key !== key || t.type !== type) return '';
            
            // åˆ¤æ–·ç´¢å¼•æ˜¯å¦åŒ¹é…
            if (t.index !== idx) return '';

            // å›å‚³å°æ‡‰çš„ Class
            if (t.action === 'del') return 'fading-out';
            if (t.action === 'add') return 'pop-in';
            return '';
        },
        // æ²å‹•è¼”åŠ©å‡½å¼
        scrollToTarget(r, action) {
            this.$nextTick(() => {
                const container = document.querySelector('.grid-editor-wrapper');
                if (!container) return;

                if (action.includes('Row')) {
                    // æ©«åˆ—ï¼šæ°¸é æ²åˆ°åº•éƒ¨
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                } 
                else if (action.includes('Col')) {
                    // ç›´è¡Œï¼šä¾ç·¨è™Ÿæ–¹å‘æ±ºå®š
                    if (r.numberingType === 'normal') {
                        container.scrollTo({ left: container.scrollWidth, behavior: 'smooth' });
                    } else {
                        container.scrollTo({ left: 0, behavior: 'smooth' });
                    }
                }
            });
        },
        // ä½ˆå±€æ“ä½œ (å«æ–°å¢/åˆªé™¤é›™å‘å‹•ç•«)
        modifyLayout(key, action) {
            if (this.isLayoutAnimating) return;

            const r = this.rooms[key];
            let targetIndex = -1;
            let targetType = action.includes('Row') ? 'row' : 'col';
            
            // ç”¨ä¾†è¨ˆç®—èˆŠè³‡æ–™çš„ä½ç§»é‡
            let shiftRow = 0;
            let shiftCol = 0;

            if (action.startsWith('add')) {
                if(action==='addRow') {
                    if (r.rowSpecs.length >= 30) return;
                    r.rowSpecs.push(1);
                    targetIndex = r.rowSpecs.length - 1;
                    // å¾€ä¸‹åŠ ï¼ŒèˆŠè³‡æ–™ä¸ç”¨å‹• (shiftRow = 0)
                }
                else if(action==='addCol') {
                    if (r.colSpecs.length >= 30) return;
                    
                    if (r.numberingType === 'normal') {
                        // 1->N (å¾€å³åŠ )
                        r.colSpecs.push(1);
                        targetIndex = r.colSpecs.length - 1;
                        // èˆŠè³‡æ–™ä¸ç”¨å‹•
                    } else {
                        // N<-1 (å¾€å·¦åŠ )
                        r.colSpecs.unshift(1);
                        targetIndex = 0;
                        // [é—œéµä¿®æ­£] èˆŠè³‡æ–™è¦å…¨éƒ¨å¾€å³ç§» 1 æ ¼ï¼Œè®“å‡ºå·¦é‚Šçµ¦æ–°è¡Œ
                        shiftCol = 1; 
                    }
                }
                
                // å‚³å…¥ shiftCol
                this.regenerateRoom(key, true, shiftRow, shiftCol);
                
                // å‹•ç•«èˆ‡æ²å‹•
                this.isLayoutAnimating = true;
                this.animTarget = { key, type: targetType, index: targetIndex, action: 'add' };
                this.scrollToTarget(r, action);

                setTimeout(() => {
                    this.isLayoutAnimating = false;
                    this.animTarget = { key: null, type: null, index: -1, action: null };
                }, 300);
            }

            // --- åˆªé™¤é‚è¼¯ ---
            else if (action.startsWith('del')) {
                if(action==='delRow') {
                    if (r.rowSpecs.length <= 1) return;
                    targetIndex = r.rowSpecs.length - 1;
                }
                else if(action==='delCol') {
                    if (r.colSpecs.length <= 1) return;
                    targetIndex = (r.numberingType === 'normal') ? r.colSpecs.length - 1 : 0;
                }

                this.isLayoutAnimating = true;
                this.animTarget = { key, type: targetType, index: targetIndex, action: 'del' };
                this.scrollToTarget(r, action);

                setTimeout(() => {
                    if (action === 'delRow') r.rowSpecs.pop();
                    if (action === 'delCol') {
                        if (r.numberingType === 'normal') {
                            r.colSpecs.pop();
                        } else {
                            r.colSpecs.shift();
                            shiftCol = -1; 
                        }
                    }
                    
                    // å‚³å…¥ shiftCol
                    this.regenerateRoom(key, true, 0, shiftCol);

                    this.isLayoutAnimating = false;
                    this.animTarget = { key: null, type: null, index: -1, action: null };
                }, 300);
            }
        },
        toggleColType(key, idx) {
            this.rooms[key].colSpecs[idx] = this.rooms[key].colSpecs[idx]===1 ? 0 : 1;
            this.regenerateRoom(key, true);
        },
        toggleRowType(key, idx) {
            this.rooms[key].rowSpecs[idx] = this.rooms[key].rowSpecs[idx]===1 ? 0 : 1;
            this.regenerateRoom(key, true);
        },
        toggleSeat(key, r, c) {
            const s = this.getSeat(key, r, c);
            if(s.type === 1) s.type = 2;
            else if(s.type === 2) s.type = 1;
        },
        // åˆ‡æ›ç·¨è™Ÿæ–¹å‘
        toggleNumberingType(key) {
            const room = this.rooms[key];
            
            room.numberingType = room.numberingType === 'normal' ? 'inverse' : 'normal';
            
            this.regenerateRoom(key, true); 
            this.$nextTick(() => {
                this.animateHeaders(key); 
            });
        },
        // é€ä¸€è§¸ç™¼ç›´è¡Œç·¨è™Ÿå‹•ç•«
        animateHeaders(key) {
            const room = this.rooms[key];
            const animatedElements = []; 

            // 1. æ‰¾å‡ºæ‰€æœ‰åº§ä½è¡Œçš„ DOM å…ƒç´ åŠå…¶é¡¯ç¤ºç·¨è™Ÿ
            for(let idx = 0; idx < room.headers.length; idx++) {
                const h = room.headers[idx];
                if (h !== 'èµ°é“') {
                    const num = parseInt(h);
                    // æ ¹æ“š HTML è£¡è¨­å®šçš„ ID æ ¼å¼å°‹æ‰¾å…ƒç´ 
                    const el = document.getElementById(`col-h-${key}-${idx}`); 
                    if (el) {
                        animatedElements.push({ num, el });
                    }
                }
            }

            // 2. ä¾æ“šç·¨è™Ÿæ’åº (å¾å°åˆ°å¤§)
            animatedElements.sort((a, b) => a.num - b.num);

            // 3. é€ä¸€åŸ·è¡Œå‹•ç•«
            let delay = 0;
            animatedElements.forEach(({ el }, index) => {
                setTimeout(() => {
                    // åŠ ä¸Šå‹•ç•« Class
                    el.classList.add('header-pulse');
                    
                    // 0.6 ç§’å¾Œç§»é™¤ Class (ç¢ºä¿å‹•ç•«å¯é‡è¤‡è§¸ç™¼)
                    setTimeout(() => {
                        el.classList.remove('header-pulse');
                    }, 600); 

                }, delay);
                delay += 80; // æ¯å€‹å…ƒç´ é–“éš” 80 æ¯«ç§’
            });
        },
        toggleEntrance(key) {
            this.rooms[key].entrance = this.rooms[key].entrance==='right'?'left':'right';
        },
        toggleEntrancePos(key) {
             this.rooms[key].entrancePos = this.rooms[key].entrancePos==='front'?'back':'front';
        },
        
        getSeat(key, r, c) {
            const room = this.rooms[key];
            return room.seats[r * room.colSpecs.length + c] || {type:0};
        },
        getGridStyle(key) {
            const room = this.rooms[key];
            if (!room) return {}; // é˜²å‘†

            // 1. è¨­å®šæ¬„å¯¬ (ç›´è¡Œ)
            const cols = room.colSpecs.map(s => s===1 ? 'var(--seat-w)' : 'var(--aisle-w)').join(' ');
            
            // 2. [æ–°å¢] è¨­å®šåˆ—é«˜ (æ©«åˆ—)
            // ç¬¬ä¸€åˆ—æ˜¯ã€Œè¡Œæ¨™é¡Œ(1,2,3...)ã€ï¼Œè¨­ç‚º auto
            // å¾ŒçºŒæ¯ä¸€åˆ—ä¾ç…§ rowSpecs è¨­å®šï¼š1ç‚ºåº§ä½é«˜åº¦ï¼Œ0ç‚ºèµ°é“å¯¬åº¦(è®“å®ƒè®Šæ‰)
            const rows = room.rowSpecs.map(s => s===1 ? 'var(--seat-h)' : 'var(--aisle-w)').join(' ');

            return { 
                gridTemplateColumns: `var(--row-label-w) ${cols} var(--row-label-w)`,
                gridTemplateRows: `auto ${rows}` // åŠ ä¸Š auto æ˜¯ç‚ºäº†ä¿ç•™çµ¦æœ€ä¸Šæ–¹çš„è¡Œæ¨™é¡Œ
            };
        },
        getRoomAvailable(key) {
            return this.rooms[key].seats ? this.rooms[key].seats.filter(s => s.type===1).length : 0;
        },
        getRoomCapacity(key) {
            return this.rooms[key].seats ? this.rooms[key].seats.length : 0;
        },
        countAssigned(key) {
             return this.rooms[key].seats ? this.rooms[key].seats.filter(s=>s.student).length : 0;
        },
        
        checkQuota(key) {
            const capacity = this.getRoomAvailable(key);
            let otherAssigned = 0;
            const last = this.lastActiveRoomKey;
            this.sortedRoomKeys.forEach(k => {
                if (k !== last && k !== key) {
                    otherAssigned += (this.roomQuotas[k] || 0);
                }
            });
            const remainingStudents = Math.max(0, this.students.length - otherAssigned);
            const trueLimit = Math.min(capacity, remainingStudents);
            if (this.roomQuotas[key] > trueLimit) {
                this.roomQuotas[key] = trueLimit;
            }
        },

        // --- æµç¨‹æ§åˆ¶ ---
        goNext() {
            if(this.step===1 && this.students.length===0) {
                alert('è«‹å…ˆæ–°å¢è€ƒç”Ÿåå–®'); return;
            }
            if(this.step===2) {
                if(this.sortedRoomKeys.length === 0) {
                    alert('è«‹åœ¨ã€Œè€ƒå ´å•Ÿç”¨ã€ä¸­è‡³å°‘å‹¾é¸ä¸€é–“è€ƒå ´'); return;
                }
                if(this.totalAvailable < this.students.length) {
                    alert(`åº§ä½æ•¸é‡ä¸è¶³ï¼Œå°šç¼º ${this.students.length - this.totalAvailable} å€‹åº§ä½ï¼\nè«‹å•Ÿç”¨æ›´å¤šè€ƒå ´æˆ–å¢åŠ åº§ä½ã€‚`); 
                    return;
                }
                
                // é€²åˆ° Step 3 å‰ï¼Œæª¢æŸ¥ä¸¦ä¿®æ­£æ‰‹å‹•é…é¡ (é¿å…å®¹é‡æ¸›å°‘å¾Œï¼Œé…é¡å»é‚„åœ¨)
                this.sortedRoomKeys.forEach(key => {
                    const capacity = this.getRoomAvailable(key);
                    // å¦‚æœé…é¡å°šæœªè¨­å®š(undefined) æˆ– è¶…éå®¹é‡ï¼Œå¼·åˆ¶ä¿®æ­£
                    if (this.roomQuotas[key] === undefined || this.roomQuotas[key] > capacity) {
                        this.roomQuotas[key] = 0; // æˆ–è€…è¨­ç‚º capacityï¼Œè¦–éœ€æ±‚è€Œå®šï¼Œè¨­ç‚º 0 è¼ƒä¿éšª
                    }
                });

                if (this.sortedRoomKeys.length === 1) {
                    this.assignConfig.distribute = 'auto';
                }

                this.previewRoomKey = this.sortedRoomKeys[0];
            }
            this.step++;
        },

        // --- Step 3: åˆ†é…åŸ·è¡Œ ---
        getAutoCount(targetKey) {
            let remaining = this.students.length;
            
            // ä¾ç…§æ•™å®¤é †åºæ‰£é™¤
            for (const key of this.sortedRoomKeys) {
                const capacity = this.getRoomAvailable(key);
                // è©²æ•™å®¤åˆ†é…æ•¸ = å‰©é¤˜äººæ•¸ èˆ‡ è©²æ•™å®¤å®¹é‡ å–æœ€å°å€¼
                const assign = Math.min(remaining, capacity);
                
                if (key === targetKey) return assign;
                
                remaining -= assign;
            }
            return 0;
        },

        runAssignment() {
            if(this.isOverloaded) {
                alert('äººæ•¸é…ç½®éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é…é¡è¨­å®š'); return;
            }

            // 1. æ¸…ç©ºåº§ä½
            Object.values(this.rooms).forEach(r => r.seats.forEach(s => s.student = null));

            // 2. æº–å‚™åå–®æ± 
            let pool = [...this.students];

            // 3. æº–å‚™ç›®æ¨™åº§ä½
            let targets = [];
            this.sortedRoomKeys.forEach(key => {
                let validSeats = this.rooms[key].seats.filter(s => s.type === 1);
                const p = this.fillPrefs;
                validSeats.sort((a,b) => {
                    let rA=a.rIdx, rB=b.rIdx, cA=a.cIdx, cB=b.cIdx;
                    if(p.rowDir === 'backward') { rA = -rA; rB = -rB; }
                    if(p.colDir === 'right_left') { cA = -cA; cB = -cB; }
                    if(p.priority === 'row') return rA !== rB ? rA - rB : cA - cB;
                    else return cA !== cB ? cA - cB : rA - rB;
                });
                targets.push({ key, seats: validSeats });
            });

            // 4. å¡«å…¥
            let currentIdx = 0;
            targets.forEach(t => {
                // è¨ˆç®—è©²æ•™å®¤è¦æ‹¿å¤šå°‘äºº (limit)
                let limit = 0;
                
                if(this.assignConfig.distribute === 'auto') {
                    // è©²æ•™å®¤çš„é…é¡ = è©²æ•™å®¤çš„ç¸½åº§ä½æ•¸
                    // ç³»çµ±æœƒå¾ pool ä¾åºå–å‡ºé€™éº¼å¤šäººå¡«æ»¿å®ƒ
                    limit = t.seats.length;
                } else {
                    // æ‰‹å‹•æŒ‡å®šæ¨¡å¼
                    if(t.key === this.lastActiveRoomKey) limit = 99999;
                    else limit = this.roomQuotas[t.key] || 0;
                }

                // åˆ‡å‰²å­åå–®
                let subPool = pool.slice(currentIdx, currentIdx + limit);
                currentIdx += subPool.length;

                // [å…¥åº§éšæ®µ] æ±ºå®šæ˜¯å¦è¦æ‰“äº‚
                if(this.assignConfig.seat === 'random') {
                    subPool = this.shuffle(subPool);
                }

                // å¡«å…¥åº§ä½
                for(let i=0; i<subPool.length && i<t.seats.length; i++) {
                    t.seats[i].student = subPool[i];
                }
            });

            // éå ´å‹•ç•«èˆ‡è·³è½‰
            if (this.step === 4) {
                this.isReloading = true;
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    this.isReloading = false;
                }, 300);
            } else {
                this.step = 4;
            }
            this.previewRoomKey = this.sortedRoomKeys[0];
        },
        shuffle(arr) {
            return arr.sort(() => Math.random() - 0.5);
        },

        // --- Step 4: åŒ¯å‡º ---
        getRoomAssignedList(key) {
            let list = [];
            if(this.rooms[key].seats) {
                this.rooms[key].seats.forEach(s => {
                    if(s.student) list.push(s.student);
                });
            }
            return list.sort((a,b) => a.sID.localeCompare(b.sID));
        },
        getRoomSplitStudents(key) {
            let list = this.getRoomAssignedList(key);
            const half = Math.ceil(list.length / 2);
            return [list.slice(0, half), list.slice(half)];
        },
        getPagedList(students) {
            // æ’åº
            const sorted = [...students].sort((a, b) => a.sID.localeCompare(b.sID));
            
            // [ä¿®æ”¹] å¾è¨­å®šè®€å–è®Šæ•¸
            const rowsPerPage = this.exportConfig.rowsPerPage || 25;
            const colsPerPage = this.exportConfig.colsPerPage || 2;
            
            const itemsPerPage = rowsPerPage * colsPerPage; 
            
            const pages = [];
            
            for (let i = 0; i < sorted.length; i += itemsPerPage) {
                const pageItems = sorted.slice(i, i + itemsPerPage);
                
                // ä¾æ“šæ¬„æ•¸åˆ‡å‰²è³‡æ–™
                const columns = [];
                for(let c = 0; c < colsPerPage; c++) {
                    const start = c * rowsPerPage;
                    const end = start + rowsPerPage;
                    const colData = pageItems.slice(start, end);
                    
                    // è£œç©ºè¡Œ (ç¢ºä¿è¡¨æ ¼é«˜åº¦ä¸€è‡´)
                    while (colData.length < rowsPerPage) colData.push({ empty: true });
                    
                    columns.push(colData);
                }

                pages.push({ 
                    pageIndex: pages.length + 1,
                    columns: columns // [ä¿®æ”¹] é€™è£¡æ”¹ç‚ºå„²å­˜æ¬„ä½é™£åˆ—ï¼Œä¸å†åªæ˜¯ left/right
                });
            }
            return pages;
        },
    },
    mounted() {
        this.initRooms();
    }
}).mount('#app');
</script>
</body>
</html>